<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Bible Paragraph Sermon</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#161922; --text:#e6e8ef; --muted:#9aa0ab;
      --accent:#6ea8fe; --border:#252a36; --danger:#ff6b6b; --titleBlue:#9fd0ff;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg); color:var(--text);
      display:grid; grid-template-rows:64px 1fr; gap:10px;
    }
    header{
      display:flex; align-items:center; gap:10px; padding:8px 10px;
      background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:5;
    }
    header h1{ font-size:16px; margin:0; font-weight:700 }
    .muted{ color:var(--muted) }
    .pill{
      display:flex; gap:8px; align-items:center; border:1px solid var(--border);
      background:color-mix(in hsl, var(--panel) 80%, black 8%); padding:6px 8px; border-radius:10px;
    }
    select, input[type="range"]{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:4px 6px }
    option{ color:#000 }
    button{
      background:color-mix(in hsl, var(--panel) 65%, black 10%); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:6px 10px; cursor:pointer;
      transition:border-color .15s, transform .04s;
    }
    button:hover{ border-color:color-mix(in hsl, var(--border) 80%, var(--accent) 20%) }
    button:active{ transform:translateY(1px) }
    .primary{
      background:linear-gradient(180deg,color-mix(in srgb, var(--accent) 75%, white 10%), color-mix(in srgb, var(--accent) 75%, black 20%));
      border-color:color-mix(in srgb, var(--accent) 70%, black 10%);
    }

    .layout{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 10px 12px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; min-width:0 }
    .scroller{ overflow:auto; padding:12px }
    .footer{ padding:8px 12px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap }

    #tree{ padding:8px }
    details{
      border:1px solid var(--border); border-radius:10px; padding:6px 8px; margin-bottom:8px;
      background:color-mix(in hsl, var(--panel) 80%, black 8%);
    }
    summary{ cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px }
    summary::-webkit-details-marker{ display:none }
    .tw{ font-weight:700 }
    .chapters{ display:grid; gap:6px; margin-top:6px }
    .paras{ display:grid; gap:6px; margin:8px 0 2px }
    .chip{
      font-size:.92em; padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      display:inline-flex; align-items:center; gap:6px; background:color-mix(in hsl, var(--panel) 88%, black 4%); white-space:nowrap;
    }
    .chip:hover{ border-color:var(--accent) }
    .ptitle{ font-weight:800; color:var(--titleBlue) }
    .vrange{ color:var(--muted); font-weight:700 }

    .pbody{ margin-top:8px; border-top:1px dashed var(--border); padding-top:8px }
    .ptoolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px }

    /* âœ… ì„¤êµ ë²„íŠ¼ì´ ê°€ë ¤ì§€ê±°ë‚˜ ì‚¬ë¼ì§€ëŠ” ê²ƒ ë°©ì§€ */
    .ptoolbar .spacer { flex: 1 1 auto; }
    .ptoolbar .sermBtn { display: inline-flex; }

    .pline{ padding:4px 6px; border-left:3px solid transparent; border-radius:8px; transition: background .15s, border-color .15s }
    .pline:hover{ background:color-mix(in hsl, var(--panel) 80%, black 12%) }
    .pline.reading{ background:color-mix(in hsl, var(--accent) 15%, black 0%); border-left-color:var(--accent) }
    .pv{ color:var(--muted); font-size:.88em; vertical-align:super; margin-right:4px }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal{ width:min(1200px, 96vw); max-height:94vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:14px }
    .modal .head{
      position:sticky; top:0; background:var(--panel); padding:12px 14px;
      display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--border)
    }
    .list{ padding:12px 14px; display:grid; gap:8px }
    .item{ border:1px solid var(--border); border-radius:10px; padding:6px 10px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
    .item-title{ font-weight:700; color:var(--titleBlue); line-height:1.15; display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .item-title .date{ margin-left:8px; color:var(--muted); font-weight:400; font-size:.92em }

    .editor{ padding:14px; display:grid; gap:12px; background:var(--panel) }
    .editor input[type="text"], .editor textarea{ width:100%; background:#161922; color:#e6e8ef; border:1px solid #2a3040; border-radius:8px; padding:10px 12px }
    .editor textarea{ min-height:360px; resize:vertical }
    .editor-bar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .editor-bar .grow{ flex:1 1 auto }

    /* [ë§¥ë½ í¸ì§‘ê¸° ì „ìš©] ë³´ê¸° ì¢‹ì€ íƒ€ì´í¬/ë ˆì´ì•„ì›ƒ */
    .context-editor {
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      font-size: 1.05rem;
      line-height: 1.85;
      letter-spacing: 0.02em;
      word-break: keep-all;
      background: var(--panel);
      color: var(--text);
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }
    .context-editor input[type="text"]{
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      font-weight: 600;
      font-size: 1.12rem;
      letter-spacing: 0.01em;
    }
    .context-editor .rte{
      min-height:360px;resize:vertical;padding:14px;background:#161922;border:1px solid #2a3040;border-radius:10px;line-height:1.85;letter-spacing:.015em;caret-color:var(--accent);outline:none
    }
    .context-editor em,.context-editor strong,.context-editor b{
      color:#ffd66e;font-weight:600;font-style:normal
    }
    .context-editor blockquote{
      margin:12px 0;padding:10px 14px;border-left:3px solid var(--accent);
      color:#c0cad6;font-style:italic;background:rgba(255,255,255,.04);border-radius:8px
    }
    .context-editor ::selection{background:rgba(110,168,254,.25)}
    @media (max-width:640px){.context-editor{font-size:1rem}}
    @media (prefers-color-scheme:light){
      .context-editor{color:#1b2533;background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.08)}
      .context-editor blockquote{color:#445066;background:#f7f9fc}
    }

    /* ==== ëª¨ë‹¬ í¸ì§‘ê¸°(sermonEditor) ì¤„ ê°„ê²© íƒ€ì´íŠ¸ ëª¨ë“œ ==== */
    #sermonEditor.context-editor .rte{
      line-height: 1.55 !important;
      letter-spacing: 0.01em !important;
    }
    #sermonEditor.context-editor .rte p{ margin: 6px 0; }
    #sermonEditor.context-editor .rte .verse-line{ line-height: 1.5; }
    #sermonEditor.context-editor .rte .verse-line sup{ margin-right:4px; }
    #sermonEditor.context-editor .rte br{ line-height: 1.0; }

    /* ===== ëª¨ë‹¬ í¸ì§‘ê¸°: ë³¸ë¬¸ë§Œ ìŠ¤í¬ë¡¤ ===== */
    #sermonEditor{
      display:flex; flex-direction:column;
      height: calc(94vh - 56px); min-height: calc(94vh - 56px); max-height: calc(94vh - 56px);
      overflow: hidden;
    }
    #sermonEditor .rte {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding-top: var(--editor-pad-top, 0px);
      margin-top: 0 !important;
      scroll-padding-top: var(--editor-pad-top, 0px);
    }

    /* RTE íˆ´ë°” ê³ ì • */
    #rteToolbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }

    /* ===== ì‚½ì…ëœ ì„±ê²½êµ¬ì ˆ ìŠ¤íƒ€ì¼ ===== */
    .inserted-verse { font-style: italic; color: #ff8080; }
    .verse-header { margin-bottom:2px; }
    .verse-line { font-style: italic; color:#ff8080; }

    /* ì„¤êµëª©ë¡ ë§í¬ í•„ë“œ */
    .link-box{
      display:flex; align-items:center; gap:6px; min-width:260px; flex:1 1 320px;
    }
    .link-box input{
      flex:1 1 auto; min-width:200px;
      background:#161922;color:#e6e8ef;border:1px solid #2a3040;border-radius:8px;padding:6px 8px
    }
    .link-box a{
      text-decoration:underline; color:#9fd0ff; word-break:break-all;
      max-width:280px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .ptoolbar .sermBtn{ margin-left:auto }

    /* ì‘ê¸‰: ì„¤êµ ë²„íŠ¼ ê°€ì‹œì„± ê°•ì œ */
    .ptoolbar .sermBtn { display:inline-flex !important; visibility:visible !important; opacity:1 !important; }

    /* === ì ˆë¬¸ì¥ ì„œì‹ íˆ´ë°” === */
    #wbp-plbar{
      position: fixed; left:0; top:0;
      transform: translate(-50%, calc(-100% - 10px));
      background:#0f1320; border:1px solid var(--border, #252a36);
      border-radius:10px; padding:6px;
      display:flex; gap:6px; align-items:center;
      box-shadow:0 8px 20px rgba(0,0,0,.35); z-index:9999;
    }
    #wbp-plbar[hidden]{ display:none; }
    #wbp-plbar .divider{ width:1px; height:20px; background:var(--border, #252a36); }
    #wbp-plbar button{
      border:1px solid var(--border, #252a36); background:#1f2533; color:#e6e8ef;
      padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700;
    }
    #wbp-plbar button:hover{ background:#273046; }

    /* ìƒ‰ìƒ íŒ”ë ˆíŠ¸(6ìƒ‰) + ë”ë³´ê¸° ë“œë¡­ë‹¤ìš´ */
    #wbp-color-menu{ position:relative; }
    #wbp-color-more{
      position:absolute; top:calc(100% + 6px); left:0;
      background:#0f1320; border:1px solid var(--border, #252a36);
      border-radius:10px; padding:8px; display:none; gap:6px; flex-wrap:wrap;
    }
    #wbp-color-more [data-color]{ width:20px; height:20px; border-radius:4px; border:1px solid #0005; cursor:pointer; }
    #wbp-color-menu.open #wbp-color-more{ display:flex; }

    /* ==== ì»¨í…ì¸ ê°€ ì±„ì›Œì§„ ë²„íŠ¼ ì‹œê° ê°•ì¡° ==== */
    .ptoolbar button.filled {
      color:#fff; border-width:1px; box-shadow:0 0 6px rgba(0,0,0,0.25);
    }
    .ptoolbar .btnSummary.filled { background:#6a5acd; border-color:#7b68ee; }
    .ptoolbar .btnUnitCtx.filled { background:#9370db; border-color:#b48cf0; }
    .ptoolbar .btnWholeCtx.filled{ background:#4682b4; border-color:#5ca5e5; }
    .ptoolbar .btnCommentary.filled{ background:#3cb371; border-color:#58d68d; }
    .ptoolbar .sermBtn.filled    { background:#ff8c00; border-color:#ffa94d; }
    .ptoolbar button.filled::after{ content:"â—"; font-size:10px; margin-left:6px; opacity:.8; color:rgba(255,255,255,0.85); }

    .ptoolbar button { transition: background .25s ease, border-color .25s ease, color .25s ease; }

    /* í¸ì§‘ ëª¨ë“œ í‘œì‹œ */
    details.para .pcontent[contenteditable="true"]{
      outline: 1px dashed #3b4b7a; outline-offset: 2px;
    }
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&family=Nanum+Myeongjo&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <h1>Web Bible Paragraph 3.0</h1>

    <div class="pill"><button id="btnSaveJSON">JSON ì €ì¥</button></div>

    <div class="pill">
      <button id="btnExportAll">ë‚´ë³´ë‚´ê¸°</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="btnImportAll">ê°€ì ¸ì˜¤ê¸°</button>
    </div>

    <div class="pill">
      <span class="muted">ìŒì„±</span>
      <select id="voiceSelect" title="í•œêµ­ì–´ ë³´ì´ìŠ¤ ì„ íƒ">
        <option value="">ë¸Œë¼ìš°ì € ê¸°ë³¸(ko-KR)</option>
      </select>
      <button id="testVoice">ì‹œí—˜</button>
    </div>

    <div class="pill">
      <span class="muted">ì†ë„</span>
      <input id="rateCtl" type="range" min="0.6" max="1.4" step="0.02" value="0.95" />
      <span class="muted">í†¤</span>
      <input id="pitchCtl" type="range" min="0.6" max="1.4" step="0.02" value="1.00" />
    </div>

    <div class="pill" id="voiceHint" style="display:none">
      <span class="muted">í•œêµ­ì–´ ë³´ì´ìŠ¤ê°€ 1ê°œë¿ì´ë¼ ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.</span>
    </div>

    <div style="flex:1"></div>
    <div class="pill"><span class="muted">ë‹¨ì¶•í‚¤:</span> <span> S</span> ì¬ìƒ/ì¤‘ì§€ <span> Â· N</span> ë‹¤ìŒ ë‹¨ë½</div>
  </header>

  <div class="layout">
    <section class="card">
      <div class="scroller"><div id="tree"></div></div>
      <div class="footer"><div class="muted" id="status">bible-paragraph.jsonì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
    </section>
  </div>

  <div id="modalWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <strong id="modalTitle">ë‹¨ë½ ì„±ê²½</strong>
        <span class="muted" id="modalRef">â€”</span>
        <div class="grow"></div>
        <button id="closeModal">ë‹«ê¸°</button>
      </div>

      <div class="list" id="sermonList"></div>

      <!-- ë‹¨ì¼ í¸ì§‘ê¸° (ì¤‘ë³µ ì œê±°) -->
      <div class="editor context-editor" id="sermonEditor" style="display:none">
        <div id="rteToolbar" class="editor-bar">
          <button type="button" onclick="execFmt('bold')"><b>B</b></button>
          <button type="button" onclick="execFmt('italic')"><i>I</i></button>
          <button type="button" onclick="execFmt('underline')"><u>U</u></button>
          <button type="button" onclick="execFmt('strikeThrough')"><s>S</s></button>
          <div class="grow"></div>
        </div>

        <input id="sermonTitle" type="text" placeholder="ì œëª©" style="display:none" />
        <div id="sermonBody" class="rte" contenteditable="true" spellcheck="false"></div>

        <div class="editor-bar">
          <div class="grow"></div>
          <button id="editorSpeak" class="primary">ë‚­ë…</button>
          <button id="saveSermon" class="primary">ì €ì¥</button>
        </div>
      </div>

      <div id="modalFooterNew" class="footer" style="padding:10px 14px; border-top:1px solid var(--border)">
        <button id="newSermonBtn" class="primary">ìƒˆ ì„¤êµ</button>
      </div>
    </div>
  </div>

  <!-- í”Œë¡œíŒ… ì„œì‹íˆ´ë°”: ì ˆ(.verse/.pline) ì„ íƒ ì‹œ í‘œì‹œ -->
  <div id="wbp-plbar" hidden role="toolbar" aria-label="ì ˆ ì„œì‹">
    <button type="button" data-cmd="bold" title="êµµê²Œ (Ctrl+B)"><b>B</b></button>
    <button type="button" data-cmd="italic" title="ê¸°ìš¸ì„ (Ctrl+I)"><i>I</i></button>
    <button type="button" data-cmd="underline" title="ë°‘ì¤„ (Ctrl+U)"><u>U</u></button>
    <div class="divider" style="margin:0 4px;"></div>

    <!-- 6ìƒ‰ ê³ ì • íŒ”ë ˆíŠ¸ -->
    <button type="button" data-color="#ff4d4f" title="ë¹¨ê°•" style="width:28px;height:28px;border-radius:6px;background:#ff4d4f;border:1px solid #0005"></button>
    <button type="button" data-color="#faad14" title="ì£¼í™©" style="width:28px;height:28px;border-radius:6px;background:#faad14;border:1px solid #0005"></button>
    <button type="button" data-color="#fadb14" title="ë…¸ë‘" style="width:28px;height:28px;border-radius:6px;background:#fadb14;border:1px solid #0005"></button>
    <button type="button" data-color="#52c41a" title="ì´ˆë¡" style="width:28px;height:28px;border-radius:6px;background:#52c41a;border:1px solid #0005"></button>
    <button type="button" data-color="#1890ff" title="íŒŒë‘" style="width:28px;height:28px;border-radius:6px;background:#1890ff;border:1px solid #0005"></button>
    <button type="button" data-color="#722ed1" title="ë³´ë¼" style="width:28px;height:28px;border-radius:6px;background:#722ed1;border:1px solid #0005"></button>

    <!-- ë”ë³´ê¸°(ë“œë¡­ë‹¤ìš´ íŒ”ë ˆíŠ¸) -->
    <div id="wbp-color-menu" style="margin-left:4px;">
      <button type="button" id="wbp-more-btn" title="ë”ë³´ê¸°" style="padding:6px 8px">â–¼</button>
      <div id="wbp-color-more">
        <div data-color="#000000" title="#000000" style="background:#000000"></div>
        <div data-color="#333333" title="#333333" style="background:#333333"></div>
        <div data-color="#666666" title="#666666" style="background:#666666"></div>
        <div data-color="#999999" title="#999999" style="background:#999999"></div>
        <div data-color="#cccccc" title="#cccccc" style="background:#cccccc"></div>
        <div data-color="#ffffff" title="#ffffff" style="background:#ffffff;border-color:#0003"></div>
        <div data-color="#e91e63" title="#e91e63" style="background:#e91e63"></div>
        <div data-color="#ff6b6b" title="#ff6b6b" style="background:#ff6b6b"></div>
        <div data-color="#7c4dff" title="#7c4dff" style="background:#7c4dff"></div>
        <div data-color="#00bcd4" title="#00bcd4" style="background:#00bcd4"></div>
        <div data-color="#00c853" title="#00c853" style="background:#00c853"></div>
        <div data-color="#ff9800" title="#ff9800" style="background:#ff9800"></div>
      </div>
    </div>

    <button type="button" data-act="clearColor" title="ìƒ‰ ì œê±°">â¨¯</button>
  </div>

  <!-- ğŸ”§ HTML ìŠ¤ëƒ…ìƒ· ë°©ì‹: í”Œë¡œíŒ…ë°” + ì„œì‹ ì €ì¥/ë³µì› ëª¨ë“ˆ -->
  <script>
  (function(){
    const STORAGE_KEY = 'wbps.versefmt.html.v1';

    function getFmtMap(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch(_){ return {}; }
    }
    function setFmtMap(obj){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    }

    // ì ˆ ê³ ìœ í‚¤: ${book}|${chap}|${para.ref}|v${verse}
    function keyForLine(lineEl){
      try{
        const paraEl = lineEl.closest('details.para'); if(!paraEl) return null;
        const t = paraEl.querySelector('summary .ptitle'); if(!t) return null;
        const book = t.dataset.book;
        const chap = parseInt(t.dataset.ch,10);
        const idx  = parseInt(t.dataset.idx,10);
        const para = (window.BIBLE?.books?.[book]?.[chap]?.paras||[])[idx];
        const v = lineEl.dataset.verse;
        if(!para || !v) return null;
        return `${book}|${chap}|${para.ref}|v${v}`;
      }catch(_){ return null; }
    }

    // í˜„ì¬ ì„ íƒì´ ìˆëŠ” ì ˆ ë¼ì¸ì˜ innerHTML ì €ì¥
    function saveCurrentLine(){
      const sel = window.getSelection?.();
      if(!sel || !sel.rangeCount) return;
      const node = sel.getRangeAt(0).commonAncestorContainer;
      const el = (node.nodeType===1 ? node : node.parentElement);
      const line = el?.closest?.('.pline, .verse-line, p.verse');
      if(!line) return;
      const key = keyForLine(line); if(!key) return;
      const map = getFmtMap();
      map[key] = line.innerHTML;
      setFmtMap(map);
    }

    // ë¼ì¸ ìƒì„±/ê°±ì‹  ì‹œ ì €ì¥ëœ HTMLë¡œ ë³µì›
    function restoreLine(line){
      const key = keyForLine(line); if(!key) return;
      const map = getFmtMap();
      if(map[key]){ line.innerHTML = map[key]; }
    }

    // ì´ˆê¸° ìŠ¤ìº” + DOM ë³€í™” ê°ì‹œë¡œ ë³µì›
    function sweepRestore(root){
      root.querySelectorAll('.pline, .verse-line, p.verse').forEach(restoreLine);
    }

    // í”Œë¡œíŒ… íˆ´ë°” í‘œì‹œ/ë™ì‘
    (function enableFloatingToolbar(){
      const bar = document.getElementById('wbp-plbar');
      if(!bar){ console.warn('[WBP] toolbar element #wbp-plbar not found'); return; }

      const LINE_SELECTOR  = '.pline, p.verse, .verse-line';
      const SCOPE_SELECTOR = '.pcontent, .editor, main, body';
      let savedRange = null;

      function hasRealSelection(){
        const sel = window.getSelection();
        return !!(sel && sel.rangeCount && !sel.getRangeAt(0).collapsed);
      }
      function findLineFromSelection(){
        const sel = window.getSelection(); if(!sel || sel.rangeCount===0) return null;
        const n = sel.getRangeAt(0).commonAncestorContainer;
        const el = (n.nodeType===1 ? n : n.parentElement);
        return el?.closest?.(LINE_SELECTOR) || null;
      }
      function ensureEditableScope(line){
        const scope = line.closest(SCOPE_SELECTOR) || line.parentElement || line;
        if(scope && scope.getAttribute('contenteditable')!=='true'){
          scope.setAttribute('contenteditable','true');
        }
      }
      function getSelRect(){
        const sel = window.getSelection();
        if(!sel || sel.rangeCount===0) return null;
        const r = sel.getRangeAt(0).cloneRange();
        let rect = r.getBoundingClientRect();
        if(!rect || (rect.width===0 && rect.height===0)){
          const span = document.createElement('span');
          span.appendChild(document.createTextNode('\u200b'));
          r.insertNode(span);
          rect = span.getBoundingClientRect();
          span.remove();
        }
        return rect;
      }
      function saveSel(){
        const sel = window.getSelection();
        if(sel && sel.rangeCount>0) savedRange = sel.getRangeAt(0).cloneRange();
      }
      function restoreSel(){
        if(!savedRange) return false;
        const sel = window.getSelection();
        sel.removeAllRanges(); sel.addRange(savedRange);
        return true;
      }
      function hide(){ bar.hidden = true; }
      function showBarIfLine(){
        if(!hasRealSelection()){ hide(); return; }
        const line = findLineFromSelection();
        if(!line){ hide(); return; }
        ensureEditableScope(line);
        const rect = getSelRect(); if(!rect){ hide(); return; }
        bar.style.left = (rect.left + rect.width/2) + 'px';
        bar.style.top  = rect.top + 'px';
        bar.hidden = false;
        saveSel();
      }

      // ê¸°ë³¸ ì„œì‹ ë²„íŠ¼(bold/italic/underline)
      bar.addEventListener('mousedown', e=> e.preventDefault());
      bar.addEventListener('click', e=>{
        const btn = e.target.closest('button'); if(!btn) return;

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const color = btn.getAttribute('data-color');
        if(color){
          if(!restoreSel()) return;
          document.execCommand('foreColor', false, color);
          setTimeout(saveCurrentLine, 0);
          setTimeout(showBarIfLine, 0);
          return;
        }

        // ë”ë³´ê¸° í† ê¸€
        if(btn.id === 'wbp-more-btn'){
          const menu = btn.parentElement;
          menu.classList.toggle('open');
          return;
        }

        // ë”ë³´ê¸° íŒ”ë ˆíŠ¸ì˜ ì¹©
        if(btn.parentElement?.id === 'wbp-color-more'){
          return;
        }

        const cmd = btn.dataset.cmd;
        const act = btn.dataset.act;
        if(cmd){
          if(!restoreSel()) return;
          document.execCommand(cmd, false, null);
          setTimeout(saveCurrentLine, 0);
          setTimeout(showBarIfLine, 0);
          return;
        }
        if(act === 'clearColor'){
          if(!restoreSel()) return;
          try{
            const sel = window.getSelection(); if(!sel || sel.rangeCount===0) return;
            const range = sel.getRangeAt(0);
            const frag  = range.cloneContents();
            const div   = document.createElement('div'); div.appendChild(frag);
            // color ì œê±°
            div.querySelectorAll('span, font').forEach(n=>{
              if(n.style?.color) n.style.color = '';
              if(n.hasAttribute?.('color')) n.removeAttribute('color');
              if(n.getAttribute?.('style')==='') n.removeAttribute('style');
            });
            range.deleteContents();
            document.execCommand('insertHTML', false, div.innerHTML || div.textContent || '');
          }catch(_){}
          setTimeout(saveCurrentLine, 0);
          setTimeout(showBarIfLine, 0);
          return;
        }
      });

      // ë”ë³´ê¸° íŒ”ë ˆíŠ¸ ì¹© í´ë¦­ í•¸ë“¤ëŸ¬(ì´ë²¤íŠ¸ ìœ„ì„)
      document.getElementById('wbp-color-more')?.addEventListener('click', (e)=>{
        const chip = e.target.closest('[data-color]'); if(!chip) return;
        const color = chip.getAttribute('data-color');
        if(!color) return;
        if(!restoreSel()) return;
        document.execCommand('foreColor', false, color);
        setTimeout(saveCurrentLine, 0);
        setTimeout(showBarIfLine, 0);
      });

      document.addEventListener('selectionchange', ()=> setTimeout(showBarIfLine, 0));
      document.addEventListener('mouseup',         ()=> setTimeout(showBarIfLine, 0));
      document.addEventListener('keyup',           ()=> setTimeout(showBarIfLine, 0));
      window.addEventListener('scroll', hide, {passive:true});
      window.addEventListener('resize', hide);

      // ë‹¨ì¶•í‚¤ Ctrl/Cmd + B/I/U
      window.addEventListener('keydown', (e)=>{
        if(!(e.ctrlKey||e.metaKey)) return;
        const k = e.key.toLowerCase();
        if(!['b','i','u'].includes(k)) return;
        const sel = window.getSelection();
        if(!sel || sel.rangeCount===0 || sel.getRangeAt(0).collapsed) return;
        e.preventDefault();
        document.execCommand(k==='b'?'bold':k==='i'?'italic':'underline', false, null);
        setTimeout(saveCurrentLine, 0);
        setTimeout(showBarIfLine, 0);
      });
    })();

    // buildTree ì´í›„/ì´ˆê¸° ë¡œë”©ì—ì„œ ìë™ ë³µì›
    function WBP_restoreAllLines(){
      const root = document.getElementById('tree'); if(!root) return;
      // ì´ˆê¸° ìŠ¤ìœ•
      (function initial(){
        root.querySelectorAll('.pline, .verse-line, p.verse').forEach(el=>{
          // restore
          const STORAGE_KEY = 'wbps.versefmt.html.v1';
          function getFmtMap(){
            try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch(_){ return {}; }
          }
          function keyForLine(lineEl){
            try{
              const paraEl = lineEl.closest('details.para'); if(!paraEl) return null;
              const t = paraEl.querySelector('summary .ptitle'); if(!t) return null;
              const book = t.dataset.book;
              const chap = parseInt(t.dataset.ch,10);
              const idx  = parseInt(t.dataset.idx,10);
              const para = (window.BIBLE?.books?.[book]?.[chap]?.paras||[])[idx];
              const v = lineEl.dataset.verse;
              if(!para || !v) return null;
              return `${book}|${chap}|${para.ref}|v${v}`;
            }catch(_){ return null; }
          }
          const key = keyForLine(el);
          const map = getFmtMap();
          if(key && map[key]) el.innerHTML = map[key];
        });
      })();

      // ì´í›„ ë™ì  ë³€í™”ëŠ” MutationObserverë¡œ ì»¤ë²„
      const mo = new MutationObserver((muts)=>{
        for(const m of muts){
          m.addedNodes?.forEach?.(node=>{
            if(!(node instanceof HTMLElement)) return;
            if(node.matches?.('.pline, .verse-line, p.verse')){
              // restore
              const STORAGE_KEY = 'wbps.versefmt.html.v1';
              function getFmtMap(){
                try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch(_){ return {}; }
              }
              function keyForLine(lineEl){
                try{
                  const paraEl = lineEl.closest('details.para'); if(!paraEl) return null;
                  const t = paraEl.querySelector('summary .ptitle'); if(!t) return null;
                  const book = t.dataset.book;
                  const chap = parseInt(t.dataset.ch,10);
                  const idx  = parseInt(t.dataset.idx,10);
                  const para = (window.BIBLE?.books?.[book]?.[chap]?.paras||[])[idx];
                  const v = lineEl.dataset.verse;
                  if(!para || !v) return null;
                  return `${book}|${chap}|${para.ref}|v${v}`;
                }catch(_){ return null; }
              }
              const key = keyForLine(node);
              const map = getFmtMap();
              if(key && map[key]) node.innerHTML = map[key];
            }
            node.querySelectorAll?.('.pline, .verse-line, p.verse')?.forEach?.(el=>{
              const STORAGE_KEY = 'wbps.versefmt.html.v1';
              function getFmtMap(){
                try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch(_){ return {}; }
              }
              function keyForLine(lineEl){
                try{
                  const paraEl = lineEl.closest('details.para'); if(!paraEl) return null;
                  const t = paraEl.querySelector('summary .ptitle'); if(!t) return null;
                  const book = t.dataset.book;
                  const chap = parseInt(t.dataset.ch,10);
                  const idx  = parseInt(t.dataset.idx,10);
                  const para = (window.BIBLE?.books?.[book]?.[chap]?.paras||[])[idx];
                  const v = lineEl.dataset.verse;
                  if(!para || !v) return null;
                  return `${book}|${chap}|${para.ref}|v${v}`;
                }catch(_){ return null; }
              }
              const key = keyForLine(el);
              const map = getFmtMap();
              if(key && map[key]) el.innerHTML = map[key];
            });
          });
        }
      });
      mo.observe(root, {subtree:true, childList:true});
    }

    // buildTreeê°€ ëë‚¬ì„ ë•Œë¥¼ ìµœëŒ€í•œ í¬ì°©
    document.addEventListener('DOMContentLoaded', ()=>{
      // 1) ì´ˆê¸° í•œ ë²ˆ ì‹œë„
      setTimeout(WBP_restoreAllLines, 300);
      // 2) #tree ë‚´ìš©ì´ ë“¤ì–´ì˜¤ëŠ” ìˆœê°„ë„ ì»¤ë²„
      const root = document.getElementById('tree');
      if(root && root.children.length===0){
        const mo = new MutationObserver((muts)=>{
          for(const m of muts){
            if(m.addedNodes && m.addedNodes.length){
              setTimeout(WBP_restoreAllLines, 0);
              mo.disconnect();
              break;
            }
          }
        });
        mo.observe(root, {childList:true});
      }
    });
  })();
  </script>

  <!-- ê¸°ì¡´ ì•± ë¡œì§ -->
  <script src="app.js" defer></script>
</body>
</html>
