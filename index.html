<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Bible â€“ Paragraph Sermon (Final Slim)</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#161922; --text:#e6e8ef; --muted:#9aa0ab;
      --accent:#6ea8fe; --border:#252a36; --danger:#ff6b6b; --titleBlue:#9fd0ff;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg); color:var(--text);
      display:grid; grid-template-rows:64px 1fr; gap:10px;
    }
    header{
      display:flex; align-items:center; gap:10px; padding:8px 10px;
      background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:5;
    }
    header h1{ font-size:16px; margin:0; font-weight:700 }
    .muted{ color:var(--muted) }
    .pill{
      display:flex; gap:8px; align-items:center; border:1px solid var(--border);
      background:color-mix(in hsl, var(--panel) 80%, black 8%); padding:6px 8px; border-radius:10px;
    }
    select, input[type="range"]{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:4px 6px }
    option{ color:#000 }
    button{
      background:color-mix(in hsl, var(--panel) 65%, black 10%); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:6px 10px; cursor:pointer;
    }
    button:hover{ border-color:color-mix(in hsl, var(--border) 80%, var(--accent) 20%) }
    .primary{
      background:linear-gradient(180deg,color-mix(in srgb, var(--accent) 75%, white 10%), color-mix(in srgb, var(--accent) 75%, black 20%));
      border-color:color-mix(in srgb, var(--accent) 70%, black 10%);
    }

    .layout{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 10px 12px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; min-width:0 }
    .scroller{ overflow:auto; padding:12px }
    .footer{ padding:8px 12px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap }

    #tree{ padding:8px }
    details{
      border:1px solid var(--border); border-radius:10px; padding:6px 8px; margin-bottom:8px;
      background:color-mix(in hsl, var(--panel) 80%, black 8%);
    }
    summary{ cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px }
    summary::-webkit-details-marker{ display:none }
    .tw{ font-weight:700 }
    .chapters{ display:grid; gap:6px; margin-top:6px }
    .paras{ display:grid; gap:6px; margin:8px 0 2px }
    .chip{
      font-size:.92em; padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      display:inline-flex; align-items:center; gap:6px; background:color-mix(in hsl, var(--panel) 88%, black 4%); white-space:nowrap;
    }
    .chip:hover{ border-color:var(--accent) }
    .ptitle{ font-weight:800; color:var(--titleBlue) }
    .vrange{ color:var(--muted); font-weight:700 }

    .pbody{ margin-top:8px; border-top:1px dashed var(--border); padding-top:8px }
    .ptoolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px }
    .pline{ padding:4px 6px; border-left:3px solid transparent; border-radius:8px; transition: background .15s, border-color .15s }
    .pline:hover{ background:color-mix(in hsl, var(--panel) 80%, black 12%) }
    .pline.reading{ background:color-mix(in hsl, var(--accent) 15%, black 0%); border-left-color:var(--accent) }
    .pv{ color:var(--muted); font-size:.88em; vertical-align:super; margin-right:4px }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal{ width:min(1200px, 96vw); max-height:94vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:14px }
    .modal .head{
      position:sticky; top:0; background:var(--panel); padding:12px 14px;
      display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--border)
    }
    .list{ padding:12px 14px; display:grid; gap:0 }
    .item{ border:1px solid var(--border); border-radius:10px; padding:2px 8px; display:flex; justify-content:space-between; align-items:center; gap:8px }
    .item-title{ font-weight:700; color:var(--titleBlue); line-height:1.15 }
    .item-title .date{ margin-left:8px; color:var(--muted); font-weight:400; font-size:.92em }

    .editor{ padding:14px; display:grid; gap:12px; background:var(--panel) }
    .editor input[type="text"], .editor textarea{ width:100%; background:#161922; color:#e6e8ef; border:1px solid #2a3040; border-radius:8px; padding:10px 12px }
    .editor textarea{ min-height:360px; resize:vertical }
    .thumbs{ display:flex; gap:8px; flex-wrap:wrap }
    .thumbs img{ width:112px; height:112px; object-fit:cover; border-radius:10px; border:1px solid var(--border) }
    .editor-bar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .editor-bar .grow{ flex:1 1 auto }

    /* [ë§¥ë½ í¸ì§‘ê¸° ì „ìš©] ë³´ê¸° ì¢‹ì€ íƒ€ì´í¬/ë ˆì´ì•„ì›ƒ */
    .context-editor {
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      font-size: 1.05rem;
      line-height: 1.85;
      letter-spacing: 0.02em;
      word-break: keep-all;
      background: var(--panel);
      color: var(--text);
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }
    .context-editor input[type="text"]{
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      font-weight: 600;
      font-size: 1.12rem;
      letter-spacing: 0.01em;
    }
    .context-editor textarea{
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      line-height: 1.9;
      letter-spacing: 0.015em;
      min-height: 420px;
      caret-color: var(--accent);
    }
    .context-editor em,.context-editor strong,.context-editor b{
      color:#ffd66e;font-weight:600;font-style:normal
    }
    .context-editor blockquote{
      margin:12px 0;padding:10px 14px;border-left:3px solid var(--accent);
      color:#c0cad6;font-style:italic;background:rgba(255,255,255,.04);border-radius:8px
    }
    .context-editor ::selection{background:rgba(110,168,254,.25)}
    @media (max-width:640px){.context-editor{font-size:1rem}}
    @media (prefers-color-scheme:light){
      .context-editor{color:#1b2533;background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.08)}
      .context-editor blockquote{color:#445066;background:#f7f9fc}
    }
    /* ëª¨ë‹¬ ë³¸ë¬¸ RTE ê³µìš© ìŠ¤íƒ€ì¼ */
    .rte{min-height:360px;resize:vertical;padding:14px;background:#161922;border:1px solid #2a3040;border-radius:10px;line-height:1.85;letter-spacing:.015em;caret-color:var(--accent);outline:none}

    /* ==== ëª¨ë‹¬ í¸ì§‘ê¸°(sermonEditor) ì¤„ ê°„ê²© íƒ€ì´íŠ¸ ëª¨ë“œ ==== */
    /* ê¸°ì¡´ .rte / .context-editorë³´ë‹¤ êµ¬ì²´ì ì¸ ì„ íƒìë¡œ ë®ì–´ì“°ê¸° */
    #sermonEditor.context-editor .rte{
      line-height: 1.55 !important;   /* ê¸°ë³¸ 1.85 â†’ 1.55 */
      letter-spacing: 0.01em !important; /* ì‚´ì§ ì¢ê²Œ */
    }

    /* ë¬¸ë‹¨ ê°„ê²©ë„ ì•½ê°„ ì¤„ì´ê¸° */
    #sermonEditor.context-editor .rte p{
      margin: 6px 0;                  /* ê¸°ë³¸ ë¸Œë¼ìš°ì € margin(ë³´í†µ 16px) â†’ 6px */
    }

    /* ì„±ê²½ì ˆ ë¸”ë¡ì€ ì½ê¸°ì„± ìœ ì§€í•˜ë©° ì•½ê°„ë§Œ íƒ€ì´íŠ¸í•˜ê²Œ */
    #sermonEditor.context-editor .rte .verse-line{
      line-height: 1.5;
    }
    #sermonEditor.context-editor .rte .verse-line sup{
      margin-right: 4px;               /* ì ˆ ë²ˆí˜¸ì™€ ë³¸ë¬¸ ê°„ê²© í™•ë³´ */
    }

    /* ì¤„ë°”ê¿ˆ(<br>) ì‚¬ì´ ì—¬ë°± ê· ì¼í™”(ì„ íƒì‚¬í•­) */
    #sermonEditor.context-editor .rte br{
      line-height: 1.0;
    }

    /* ===== ëª¨ë‹¬ í¸ì§‘ê¸°: ë³¸ë¬¸ë§Œ ìŠ¤í¬ë¡¤ ===== */
#sermonEditor{
  display:flex;
  flex-direction:column;
  max-height: calc(94vh - 56px); /* ëª¨ë‹¬ í—¤ë”Â·í‘¸í„° ì—¬ë°± ë³´ì • */
  overflow: hidden;              /* ì—ë””í„° ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ ê¸ˆì§€ */
}
#sermonEditor .rte{
  flex:1 1 auto;
  min-height:0;
  overflow:auto;                 /* ë³¸ë¬¸ë§Œ ìŠ¤í¬ë¡¤ */
}
/* ëª¨ë‹¬ RTE íˆ´ë°” ê³ ì • */
#rteToolbar{
  position: sticky;
  top: 0;
  z-index: 10;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
}

    /* ëª¨ë‹¬ í¸ì§‘ê¸° ë„êµ¬ ì ‘ê¸° */
#modalControlsWrap{
  overflow:hidden;
  transition:max-height .25s ease, opacity .25s ease;
  max-height:600px; opacity:1;
}
#modalControlsWrap.collapsed{ max-height:0; opacity:0 }
#modalToggleControlsBtn{ min-width:96px }

/* ===== ì¸ë¼ì¸ íˆ´ë°” ===== */
.inline-toolbar {
  position: absolute;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 4px 6px;
  display: flex;
  gap: 6px;
  z-index: 9999;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  transition: opacity 0.2s;
}
.inline-toolbar button {
  background: none;
  border: none;
  color: var(--text);
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
}
.inline-toolbar button:hover { color: var(--accent); }
.inline-toolbar input[type="color"] {
  width: 24px;
  height: 24px;
  border: none;
  padding: 0;
  cursor: pointer;
  background: none;
}
    
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&family=Nanum+Myeongjo&display=swap" rel="stylesheet">
</head>

<body>
  <header>
    <h1>Web Bible â€“ Paragraph Sermon</h1>

    <div class="pill"><button id="btnSaveJSON">JSON ì €ì¥</button></div>

    <div class="pill">
      <button id="btnExportAll">ë‚´ë³´ë‚´ê¸°</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="btnImportAll">ê°€ì ¸ì˜¤ê¸°</button>
    </div>

    <div class="pill">
      <span class="muted">ìŒì„±</span>
      <select id="voiceSelect" title="í•œêµ­ì–´ ë³´ì´ìŠ¤ ì„ íƒ">
        <option value="">ë¸Œë¼ìš°ì € ê¸°ë³¸(ko-KR)</option>
      </select>
      <button id="testVoice">ì‹œí—˜</button>
    </div>

    <div class="pill">
      <span class="muted">ì†ë„</span>
      <input id="rateCtl" type="range" min="0.6" max="1.4" step="0.02" value="0.95" />
      <span class="muted">í†¤</span>
      <input id="pitchCtl" type="range" min="0.6" max="1.4" step="0.02" value="1.00" />
    </div>

    <div class="pill" id="voiceHint" style="display:none">
      <span class="muted">í•œêµ­ì–´ ë³´ì´ìŠ¤ê°€ 1ê°œë¿ì´ë¼ ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.</span>
    </div>

    <div style="flex:1"></div>
    <div class="pill"><span class="muted">ë‹¨ì¶•í‚¤:</span> <span> S</span> ì¬ìƒ/ì¤‘ì§€ <span> Â· N</span> ë‹¤ìŒ ë‹¨ë½</div>
  </header>

  <div class="layout">
    <section class="card">
      <div class="scroller"><div id="tree"></div></div>
      <div class="footer"><div class="muted" id="status">bible-paragraph.jsonì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
    </section>
  </div>

  <div id="modalWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <strong id="modalTitle">ë‹¨ë½ ì„±ê²½</strong>
        <span class="muted" id="modalRef">â€”</span>
        <div class="grow"></div>
        <button id="closeModal">ë‹«ê¸°</button>
      </div>

      <div class="list" id="sermonList"></div>

      <div class="editor" id="sermonEditor" style="display:none">
       <div id="modalControlsWrap">
        <input type="text" id="sermonTitle" placeholder="ì œëª©" />
        <div id="rteToolbar" class="editor-bar" style="gap:6px; flex-wrap:wrap; margin-top:-4px;">
          <button type="button" id="rteBold"><b>êµµê²Œ</b> (Alt+B)</button>
          <button type="button" id="rteItalic"><i>ê¸°ìš¸ì„</i> (Alt+I)</button>
          <button type="button" id="rteUnderline"><u>ë°‘ì¤„</u> (Alt+U)</button>
          <label class="pill" style="display:inline-flex;align-items:center;gap:6px">
            <span class="muted">ê¸€ììƒ‰</span>
            <input id="rteColor" type="color" value="#ffffff" style="width:32px;height:28px;padding:0;border-radius:8px">
            <button type="button" id="rteApplyColor">ì ìš© (Alt+C)</button>
          </label>
         </div>
        </div>
        <!-- ğŸ”¼ğŸ”¼ğŸ”¼ ì¶”ê°€ ë -->

        <!-- ğŸ” êµì²´: textarea â†’ div[contenteditable] -->
        <div id="sermonBody" class="rte" contenteditable="true" spellcheck="false" placeholder="ë‚´ìš©"></div>

        <div class="editor-bar">
          <input type="file" id="sermonImages" accept="image/*" multiple />
          <div class="grow"></div>
          <button id="aiFill" style="display:none">AIë¡œ ì±„ìš°ê¸°</button>
          <button id="editorSpeak" class="primary">ë‚­ë…</button>
          <button id="saveSermon" class="primary">ì €ì¥</button>
          <button id="cancelEdit">ì·¨ì†Œ</button>
        </div>
        <div class="thumbs" id="sermonThumbs"></div>
      </div>


      <div id="modalFooterNew" class="footer" style="padding:10px 14px; border-top:1px solid var(--border)">
        <button id="newSermonBtn" class="primary">ìƒˆ ì„¤êµ</button>
      </div>
    </div>
  </div>

  <script>
    /* --------- Utils --------- */
    const AI_ENDPOINT = 'http://localhost:5174/api/unit-context';
    const el = id => document.getElementById(id);
    const treeEl = el('tree'), statusEl = el('status');
    function status(msg){ statusEl.textContent = msg; }
    function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    function stripBlankLines(s){return String(s||'').split(/\r?\n/).filter(l=>l.trim()!=='').join('\n');}

    function syncCurrentFromOpen(){
      const openPara = treeEl.querySelector('details.para[open]');
      if(!openPara) return false;
      const t = openPara.querySelector('summary .ptitle');
      if(!t) return false;
      const book = t.dataset.book;
      const chap = parseInt(t.dataset.ch, 10);
      const idx  = parseInt(t.dataset.idx, 10);
      const para = BIBLE?.books?.[book]?.[chap]?.paras?.[idx];
      if(!para) return false;
      CURRENT.book   = book;
      CURRENT.chap   = chap;
      CURRENT.paraIdx= idx;
      CURRENT.paraId = `${book}|${chap}|${para.ref}`;
      return true;
    }

    // ì œëª© ë³€ê²½ ë°˜ì˜
    function updateParaTitle(book, chap, idx, newTitle){
      try{
        const para = BIBLE?.books?.[book]?.[chap]?.paras?.[idx];
        if(!para) return;
        para.title = newTitle;
        const s = document.querySelector(
          `summary .ptitle[data-book="${CSS.escape(String(book))}"][data-ch="${CSS.escape(String(chap))}"][data-idx="${CSS.escape(String(idx))}"]`
        );
        if(s) s.textContent = newTitle;
      }catch(_){}
    }

    // JSON ë‹¤ìš´ë¡œë“œ
    function downloadBibleJSON(){
      if(!BIBLE){ alert('BIBLE ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const blob = new Blob([JSON.stringify(BIBLE, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bible-paragraphs.json';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      status('ìˆ˜ì •ëœ JSONì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
    }

    /* ==== ì „ì²´ ë°ì´í„° ë°±ì—…/ë³µì› ==== */
    const STORAGE_SERMON      = 'wbps.sermons.v4';
    const STORAGE_UNIT_CTX    = 'wbps.ctx.unit.v1';
    const STORAGE_WHOLE_CTX   = 'wbps.ctx.whole.v1';
    const STORAGE_COMMENTARY  = 'wbps.ctx.comm.v1';
    const STORAGE_SUMMARY     = 'wbps.ctx.summary.v1';
    const VOICE_CHOICE_KEY    = 'wbps.tts.choice.v2';

    function todayStr(){
      const d=new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function exportAllData(){
      const keys = [STORAGE_SERMON, STORAGE_UNIT_CTX, STORAGE_WHOLE_CTX, STORAGE_COMMENTARY, STORAGE_SUMMARY, VOICE_CHOICE_KEY];
      const payload = { __wbps:1, date: todayStr(), items:{} };
      keys.forEach(k=> payload.items[k] = localStorage.getItem(k) ?? null);
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      const ts = new Date();
      const tss = `${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}-${String(ts.getHours()).padStart(2,'0')}${String(ts.getMinutes()).padStart(2,'0')}`;
      a.href = URL.createObjectURL(blob);
      a.download = `wbps-backup-${tss}.json`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      status('ì „ì²´ ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.');
    }
    async function importAllData(file){
      try{
        const text = await file.text();
        const json = JSON.parse(text);
        if(!json || json.__wbps!==1 || !json.items){ alert('ë°±ì—… íŒŒì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }
        if(!confirm('ì´ ë°±ì—…ìœ¼ë¡œ í˜„ì¬ ê¸°ê¸°ì˜ ë°ì´í„°ë¥¼ ë®ì–´ì“¸ê¹Œìš”?')) return;
        Object.entries(json.items).forEach(([k,v])=>{
          if(v===null || v===undefined) localStorage.removeItem(k);
          else localStorage.setItem(k, v);
        });
        status('ê°€ì ¸ì˜¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë°˜ì˜ë©ë‹ˆë‹¤.');
      }catch(e){
        console.error(e);
        alert('ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    /* --------- Refs / State --------- */
    const voiceSelect = el('voiceSelect'), testVoiceBtn = el('testVoice');
    const rateCtl = el('rateCtl'), pitchCtl = el('pitchCtl'), voiceHint = el('voiceHint');
    const modalWrap = el('modalWrap'), modalRef = el('modalRef');
    const sermonList = el('sermonList'), sermonEditor = el('sermonEditor');
    const sermonTitle = el('sermonTitle'), sermonBody = el('sermonBody');
    // sermonBody.addEventListener('blur',()=>{sermonBody.value=stripBlankLines(sermonBody.value);});
    // sermonBody.addEventListener('paste',()=>{setTimeout(()=>{sermonBody.value=stripBlankLines(sermonBody.value);},0);});

    // ê°œí–‰ì„ ë³´ì¡´í•´ì•¼ í•˜ë¯€ë¡œ stripBlankLines ì œê±°
    sermonBody.addEventListener('blur',()=>{}); 
    sermonBody.addEventListener('paste',()=>{});

    const sermonThumbs = el('sermonThumbs'), sermonImages = el('sermonImages');
    const editorSpeakBtn = el('editorSpeak');
    const modalFooterNew = el('modalFooterNew');

    let BIBLE = null;
    let CURRENT = { book:null, chap:null, paraIdx:null, paraId:null };
    let READER = { playing:false, q:[], idx:0, synth:window.speechSynthesis||null, scope:null, btn:null, continuous:false };
    let EDITOR_READER = { playing:false, u:null, synth:window.speechSynthesis||null };

    /* --------- Boot --------- */
    (async function boot(){
      try{
        BIBLE = await tryFetchJSON('bible-paragraph.json');
      }catch(_){
        try{ BIBLE = await tryFetchJSON('bible_paragraphs.json'); }
        catch(e){ status('bible-paragraph.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°™ì€ í´ë”ì— ë‘ê³  ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.'); return; }
      }
      buildTree();
      status('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ. 66ê¶Œ íŠ¸ë¦¬ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      await setupVoices();
    })();

    (function bindButtons(){
      el('btnSaveJSON')?.addEventListener('click', downloadBibleJSON);
      const btnExport = el('btnExportAll');
      const btnImport = el('btnImportAll');
      const fileInput = el('importFile');
      if (btnExport) btnExport.onclick = exportAllData;
      if (btnImport) btnImport.onclick = ()=> fileInput && fileInput.click();
      if (fileInput) fileInput.addEventListener('change', (e)=>{
        const f = e.target.files?.[0]; if(!f) return;
        importAllData(f).finally(()=>{ e.target.value=''; });
      });
    })();

    async function tryFetchJSON(path){ const res = await fetch(path, {cache:'no-store'}); if(!res.ok) throw 0; return await res.json(); }

    /* --------- Voice --------- */
    function waitForVoices(timeout=1500){
      return new Promise(resolve=>{
        const have = speechSynthesis.getVoices?.();
        if (have && have.length) return resolve(have);
        const t = setTimeout(()=> resolve(speechSynthesis.getVoices?.()||[]), timeout);
        speechSynthesis.onvoiceschanged = ()=>{ clearTimeout(t); resolve(speechSynthesis.getVoices?.()||[]); };
      });
    }
    function getKoreanVoices(all){
      return (all||[]).filter(v=>{
        const n=(v.name||'').toLowerCase(), l=(v.lang||'').toLowerCase();
        return l.startsWith('ko') || n.includes('korean') || n.includes('í•œêµ­') || n.includes('korea');
      });
    }
    function presetsForSingleVoice(){
      return [
        {id:'preset-soft-low',  label:'í”„ë¦¬ì…‹ Â· ì €ìŒ/ëŠë¦¼',   rate:0.85, pitch:0.85},
        {id:'preset-soft-high', label:'í”„ë¦¬ì…‹ Â· ê³ ìŒ/ëŠë¦¼',   rate:0.90, pitch:1.20},
        {id:'preset-fast',      label:'í”„ë¦¬ì…‹ Â· ë¹ ë¦„',       rate:1.20, pitch:1.05},
        {id:'preset-bright',    label:'í”„ë¦¬ì…‹ Â· ë°ê²Œ',       rate:1.05, pitch:1.25},
        {id:'preset-radio',     label:'í”„ë¦¬ì…‹ Â· ë¼ë””ì˜¤í†¤',   rate:1.00, pitch:0.90},
        {id:'preset-reading',   label:'í”„ë¦¬ì…‹ Â· ë‚­ë…ì²´',     rate:0.95, pitch:1.00},
      ];
    }
    async function setupVoices(){
      const all = await waitForVoices();
      const kos = getKoreanVoices(all);

      voiceSelect.innerHTML = '';
      const def = document.createElement('option');
      def.value = JSON.stringify({type:'default'});
      def.textContent = 'ë¸Œë¼ìš°ì € ê¸°ë³¸(ko-KR)';
      voiceSelect.appendChild(def);

      if(kos.length > 0){
        const og = document.createElement('optgroup'); og.label = 'í•œêµ­ì–´ ë³´ì´ìŠ¤';
        kos.forEach(v=>{
          const opt = document.createElement('option');
          opt.value = JSON.stringify({type:'voice', uri:v.voiceURI});
          opt.textContent = `${v.name} â€” ${v.lang}${v.localService ? ' (ë¡œì»¬)' : ''}`;
          og.appendChild(opt);
        });
        voiceSelect.appendChild(og);
      }
      if(kos.length <= 1){
        const pg = document.createElement('optgroup'); pg.label = 'ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹';
        presetsForSingleVoice().forEach(p=>{
          const opt = document.createElement('option');
          opt.value = JSON.stringify({type:'preset', rate:p.rate, pitch:p.pitch});
          opt.textContent = p.label;
          pg.appendChild(opt);
        });
        voiceHint.style.display = '';
      } else {
        voiceHint.style.display = 'none';
      }

      const saved = localStorage.getItem(VOICE_CHOICE_KEY);
      if(saved){
        const idx = [...voiceSelect.options].findIndex(o=>o.value===saved);
        if(idx>=0) voiceSelect.selectedIndex = idx;
      } else {
        localStorage.setItem(VOICE_CHOICE_KEY, voiceSelect.value);
      }
      voiceSelect.addEventListener('change', ()=> localStorage.setItem(VOICE_CHOICE_KEY, voiceSelect.value));
      testVoiceBtn.onclick = ()=> speakSample('íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼.');
    }
    function resolveVoiceChoice(){
      try{ return JSON.parse(localStorage.getItem(VOICE_CHOICE_KEY)||'{"type":"default"}'); }
      catch{ return {type:'default'}; }
    }
    function pickVoiceByURI(uri){ return (speechSynthesis.getVoices?.()||[]).find(v=>v.voiceURI===uri) || null; }
    function applyVoice(u){
      const choice = resolveVoiceChoice();
      const baseRate = parseFloat(rateCtl.value||'0.95');
      const basePitch = parseFloat(pitchCtl.value||'1');
      if(choice.type==='voice'){
        const v = pickVoiceByURI(choice.uri);
        if(v){ u.voice = v; u.lang = v.lang; } else { u.lang = 'ko-KR'; }
        u.rate = baseRate; u.pitch = basePitch;
      } else if(choice.type==='preset'){
        u.lang = 'ko-KR';
        u.rate = clamp((choice.rate ?? 0.95) * baseRate / 0.95, 0.5, 2);
        u.pitch = clamp((choice.pitch ?? 1.0) * basePitch / 1.0, 0, 2);
      } else {
        u.lang = 'ko-KR'; u.rate = baseRate; u.pitch = basePitch;
      }
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
    function speakSample(text){
      const synth = window.speechSynthesis;
      try{ synth.cancel(); }catch(e){}
      const u = new SpeechSynthesisUtterance(text);
      applyVoice(u);
      synth.speak(u);
    }

    /* --------- Tree --------- */
    function buildTree(){
      treeEl.innerHTML = '';
      if(!BIBLE){ treeEl.innerHTML = '<div class="muted">íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

      for(const bookName of Object.keys(BIBLE.books)){
        const detBook = document.createElement('details');
        const sumBook = document.createElement('summary');
        sumBook.innerHTML = `<span class="tw">${escapeHtml(bookName)}</span>`;
        detBook.appendChild(sumBook);

        const chWrap = document.createElement('div'); chWrap.className='chapters';
        const chapters = Object.keys(BIBLE.books[bookName]).map(n=>parseInt(n,10)).sort((a,b)=>a-b);

        for(const ch of chapters){
          const detChap = document.createElement('details');
          const sumChap = document.createElement('summary');
          sumChap.innerHTML = `<span class="chip">${ch}ì¥</span>`;
          detChap.appendChild(sumChap);

          const parWrap = document.createElement('div'); parWrap.className='paras';
          const paras = BIBLE.books[bookName][ch].paras || [];
          paras.forEach((p, idx)=>{
            const detPara = document.createElement('details'); detPara.className='para';

            const m = String(p.ref||'').match(/^(\d+):(\d+)(?:-(\d+))?$/);
            const v1 = m ? m[2] : '?', v2 = m ? (m[3]||m[2]) : '?';
            const titleText = p.title || p.ref;

            const sum = document.createElement('summary');
            sum.innerHTML = `
              <span class="vrange">(${v1}-${v2})</span>
              <span class="ptitle"
                    data-book="${bookName}"
                    data-ch="${ch}"
                    data-idx="${idx}"
                    title="ì œëª©ì„ ë”ë¸”í´ë¦­í•˜ë©´ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤">${escapeHtml(titleText)}</span>
            `;

            const titleEl = sum.querySelector('.ptitle');

            titleEl.addEventListener('dblclick', (e)=>{
              e.preventDefault(); e.stopPropagation();
              detPara.open = true;
              startInlineTitleEdit(titleEl, bookName, ch, idx);
            }, true);

            function guardSummary(ev){
              const isEditing = titleEl.isContentEditable;
              const dblOnTitle = (ev.type === 'dblclick' && ev.target === titleEl);
              if (isEditing || dblOnTitle){
                ev.preventDefault();
                ev.stopPropagation();
              }
            }
            ['pointerdown','mousedown','click','dblclick'].forEach(type=>{
              sum.addEventListener(type, guardSummary, true);
            });

            detPara.appendChild(sum);

            const body = document.createElement('div');
            body.className = 'pbody';
            body.innerHTML = `
              <div class="ptoolbar">
                <button class="primary speakBtn">ë‚­ë…</button>
                <label class="chip"><input type="checkbox" class="keepReading" style="margin-right:6px">ê³„ì† ë‚­ë…</label>
                <button class="ctxBtn btnUnitCtx">ë‹¨ìœ„ì„±ê²½ì† ë§¥ë½</button>
                <button class="ctxBtn btnWholeCtx">ì „ì²´ì„±ê²½ì† ë§¥ë½</button>
                <button class="ctxBtn btnCommentary">ì£¼ì„</button>
                <button class="ctxBtn btnSummary">ë‚´ìš©ìš”ì•½</button>
                <div class="spacer"></div>
                <button class="sermBtn">ì„¤êµ</button>
              </div>
              <div class="pcontent"></div>`;
            detPara.appendChild(body);

            const pcontent = body.querySelector('.pcontent');
            (p.verses||[]).forEach(([v,t])=>{
              const line = document.createElement('div');
              line.className = 'pline';
              line.dataset.verse = v;
              line.innerHTML = `<sup class="pv">${v}</sup>${t}`;
              pcontent.appendChild(line);
            });

            detPara.addEventListener('toggle', ()=>{
              if(detPara.open){
                CURRENT.book = bookName; CURRENT.chap = ch; CURRENT.paraIdx = idx;
                const para = BIBLE.books[bookName][ch].paras[idx];
                CURRENT.paraId = `${bookName}|${ch}|${para.ref}`;
                status(`ì„ íƒë¨: ${bookName} ${ch}ì¥ Â· ${para.title||para.ref}`);
              }
            });

            body.querySelector('.speakBtn').addEventListener('click', ()=>{
              toggleSpeakInline(bookName, ch, idx, detPara, body.querySelector('.speakBtn'));
            });
            body.querySelector('.sermBtn').addEventListener('click', ()=>{
              CURRENT.book = bookName; CURRENT.chap = ch; CURRENT.paraIdx = idx;
              const para = BIBLE.books[bookName][ch].paras[idx];
              CURRENT.paraId = `${bookName}|${ch}|${para.ref}`;
              openSermonModal();
            });
            body.querySelector('.btnUnitCtx').addEventListener('click', ()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('unit'); });
            body.querySelector('.btnWholeCtx').addEventListener('click',()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('whole'); });
            body.querySelector('.btnCommentary').addEventListener('click',()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('commentary'); });
            body.querySelector('.btnSummary').addEventListener('click',   ()=>{ CURRENT.book=bookName; CURRENT.chap=ch; CURRENT.paraIdx=idx; openSingleDocEditor('summary'); });

            parWrap.appendChild(detPara);
          });

          detChap.appendChild(parWrap);
          chWrap.appendChild(detChap);
        }

        detBook.appendChild(chWrap);
        treeEl.appendChild(detBook);
      }
    }

    /* --------- Inline TTS --------- */
    function buildQueueFrom(book, chap, idx){
      const para = BIBLE.books[book][chap].paras[idx];
      return (para.verses||[]).map(([v,t])=>({verse:v, text:t}));
    }
    function clearReadingHighlight(scope){ [...scope.querySelectorAll('.pline')].forEach(el=> el.classList.remove('reading')); }
    function bindKeepReading(scope){
      const cb = scope.querySelector('.keepReading');
      if(!cb) return;
      cb.checked  = READER.continuous;
      cb.disabled = false;                   // í•­ìƒ ì¡°ì‘ ê°€ëŠ¥
      cb.onchange = ()=>{ READER.continuous = cb.checked; };
    }
    function speakVerseItemInScope(item, scope, onend){
      if(!READER.synth) return;
      const u = new SpeechSynthesisUtterance(String(item.text));
      applyVoice(u);
      let done = false;
      const safeEnd = ()=>{ if(done) return; done = true; onend(); };
      u.onstart = ()=>{
        clearReadingHighlight(scope);
        const line = scope.querySelector(`.pline[data-verse="${item.verse}"]`);
        if(line){ line.classList.add('reading'); line.scrollIntoView({block:'center', behavior:'smooth'}); }
        if (READER._wd){ clearTimeout(READER._wd); READER._wd = null; }
        const base = Math.max(800, Math.round(item.text.length * 65));
        const rate = u.rate || 1;
        const estimate = Math.max(600, Math.round(base / rate)) + 1200;
        READER._wd = setTimeout(safeEnd, estimate);
      };
      u.onend   = safeEnd;
      u.onerror = safeEnd;
      READER.synth.speak(u);
    }
    function toggleSpeakInline(book, chap, idx, paraDetailsEl, btnEl){
      if(!READER.synth) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      const sameScope = READER.playing && READER.scope === paraDetailsEl;
      if(READER.playing && sameScope){ stopSpeakInline(); return; }
      READER.continuous = true;   // ê¸°ë³¸ì„ ONìœ¼ë¡œ ì‹œì‘(ì›í•˜ë©´ falseë¡œ ë°”ê¾¸ì„¸ìš”)
      READER.q = buildQueueFrom(book, chap, idx);
      READER.idx = 0;
      READER.playing = true;
      READER.scope = paraDetailsEl;
      READER.btn = btnEl;
      try{ READER.synth.cancel(); }catch(e){}
      bindKeepReading(READER.scope);
      updateInlineSpeakBtn();
      playNextInQueueInline(book, chap, idx);
    }
    function playNextInQueueInline(book, chap, idx){
      if(!READER.playing) return;
      if(READER.idx >= READER.q.length){
        if(READER.continuous && goToNextParagraphInline(book, chap, idx)){
          const nextCb = READER.scope?.querySelector?.('.keepReading');
          if(nextCb){ nextCb.checked = READER.continuous; nextCb.disabled = false; }
          READER.q = buildQueueFrom(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
          READER.idx = 0;
          bindKeepReading(READER.scope);
          updateInlineSpeakBtn();
          setTimeout(()=>{ try{ READER.synth.cancel(); }catch(e){} playNextInQueueInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx); }, 120);
          return;
        }
        stopSpeakInline();
        return;
      }
      const item = READER.q[READER.idx];
      speakVerseItemInScope(item, READER.scope, ()=>{ READER.idx++; playNextInQueueInline(book, chap, idx); });
    }
    function stopSpeakInline(){
      READER.playing = false;
      try{ READER.synth && READER.synth.cancel(); }catch(e){}
      if (READER._wd){ clearTimeout(READER._wd); READER._wd = null; }
      if(READER.scope){
        const cb = READER.scope.querySelector?.('.keepReading');
        if(cb) cb.disabled = false;
        clearReadingHighlight(READER.scope);
      }
      updateInlineSpeakBtn();
      READER.scope = null; READER.btn = null;
    }

    function updateInlineSpeakBtn(){ if(READER.btn) READER.btn.textContent = READER.playing ? 'ì¤‘ì§€' : 'ë‚­ë…'; }
    function goToNextParagraphInline(book, chap, idx){
      const chObj = BIBLE.books[book][chap];
      const booksEls = [...treeEl.children];

      // í˜„ì¬ ì±…/ì¥ ìš”ì†Œ ì°¾ê¸°
      const bookNames = Object.keys(BIBLE.books);
      const bIdx = bookNames.indexOf(book);
      const bookEl = booksEls[bIdx];
      if(!bookEl) return false;

      const chaptersEls = bookEl.querySelectorAll(':scope > .chapters > details');
      const chapNums = Object.keys(BIBLE.books[book]).map(n=>parseInt(n,10)).sort((a,b)=>a-b);

      // â›” ë²„ê·¸: ê¸°ì¡´ ì½”ë“œì— chë¥¼ ì‚¬ìš© â†’ chapë¡œ êµì²´
      const chPos = chapNums.indexOf(chap);
      const chapEl = chaptersEls[chPos];
      if(!chapEl) return false;

      const paraEls = chapEl.querySelectorAll(':scope > .paras > details.para');

      // í˜„ì¬ ë‹¨ë½ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì›ë³µ
      if (READER.btn) READER.btn.textContent = 'ë‚­ë…';

      // 1) ê°™ì€ ì¥ì˜ ë‹¤ìŒ ë‹¨ë½
      if (idx < chObj.paras.length - 1){
        const nextEl = paraEls[idx + 1];
        if(nextEl){
          chapEl.open = true;
          nextEl.open = true;
          CURRENT.book = book;
          CURRENT.chap = chap;
          CURRENT.paraIdx = idx + 1;
          READER.scope = nextEl;
          READER.btn = nextEl.querySelector('.speakBtn');
          if (READER.btn) READER.btn.textContent = READER.playing ? 'ì¤‘ì§€' : 'ë‚­ë…';
          return true;
        }
      }

      // 2) ë‹¤ìŒ ì¥ì˜ ì²« ë‹¨ë½
      if (chPos >= 0 && chPos < chapNums.length - 1){
        const nextChap = chapNums[chPos + 1];
        const nextChapEl = chaptersEls[chPos + 1];
        if(nextChapEl){
          const nextParas = (BIBLE.books[book][nextChap].paras || []);
          if(nextParas.length){
            const nextParaEl = nextChapEl.querySelector(':scope > .paras > details.para');
            nextChapEl.open = true;
            if(nextParaEl) nextParaEl.open = true;

            CURRENT.book = book;
            CURRENT.chap = nextChap;
            CURRENT.paraIdx = 0;

            READER.scope = nextParaEl;
            READER.btn = nextParaEl?.querySelector('.speakBtn') || null;
            if (READER.btn) READER.btn.textContent = READER.playing ? 'ì¤‘ì§€' : 'ë‚­ë…';
            return true;
          }
        }
      }

      // 3) ë‹¤ìŒ ì±…ì˜ ì²« ì¥ ì²« ë‹¨ë½
      const bPos = bIdx;
      if (bPos >= 0 && bPos < bookNames.length - 1){
        const nextBook = bookNames[bPos + 1];
        const nextBookEl = booksEls[bPos + 1];
        if(nextBookEl){
          const firstChap = Math.min(...Object.keys(BIBLE.books[nextBook]).map(n=>parseInt(n,10)));
          const nextChapEl = nextBookEl.querySelector(':scope > .chapters > details');
          const nextParaEl = nextChapEl?.querySelector(':scope > .paras > details.para');
          if(nextParaEl){
            nextBookEl.open = true;
            nextChapEl.open = true;
            nextParaEl.open = true;

            CURRENT.book = nextBook;
            CURRENT.chap = firstChap;
            CURRENT.paraIdx = 0;

            READER.scope = nextParaEl;
            READER.btn = nextParaEl.querySelector('.speakBtn');
            if (READER.btn) READER.btn.textContent = READER.playing ? 'ì¤‘ì§€' : 'ë‚­ë…';
            return true;
          }
        }
      }

      return false;
    }


    /* --------- Sermon / Context Editors --------- */
    function getSermonMap(){ try{ return JSON.parse(localStorage.getItem(STORAGE_SERMON)||'{}'); }catch{ return {}; } }
    function setSermonMap(o){ localStorage.setItem(STORAGE_SERMON, JSON.stringify(o)); }
    function getDocMap(storageKey){ try{ return JSON.parse(localStorage.getItem(storageKey)||'{}'); }catch{ return {}; } }
    function setDocMap(storageKey, obj){ localStorage.setItem(storageKey, JSON.stringify(obj)); }

    function openSermonModal(){
      document.getElementById('modalTitle').textContent = 'ë‹¨ë½ ì„±ê²½';
        // â˜… ì„¤êµ ëª¨ë“œë¡œ ì´ˆê¸°í™” (ë§¥ë½/ì£¼ì„/ìš”ì•½ í¸ì§‘ ì”ì—¬ ìƒíƒœ ì œê±°)
      sermonEditor.dataset.ctxType = '';
      sermonEditor.dataset.editing = '';
      if(!CURRENT.paraId){ const openPara = treeEl.querySelector('details.para[open]'); if(!openPara) return; }
      const para = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
      // ì˜ˆ: ì°½ì„¸ê¸° 1ì¥ Â· íƒœì´ˆ(1â€“5) â€” ë§¥ë½ê³¼ ì£¼ì„ ê¸°ë°˜ ì„¤êµ
      modalRef.textContent = `${CURRENT.book} ${CURRENT.chap}ì¥ Â· ${para.title || para.ref} (${para.ref}) â€” ë§¥ë½ê³¼ ì£¼ì„ ê¸°ë°˜ ì„¤êµ`;

      renderSermonList();
      sermonEditor.style.display = 'none';
      sermonEditor.classList.add('context-editor');
      modalWrap.style.display = 'flex';
      modalWrap.setAttribute('aria-hidden','false');
      modalFooterNew.style.display = '';
    }
    el('closeModal').onclick = ()=>{ modalWrap.style.display='none'; modalWrap.setAttribute('aria-hidden','true'); stopEditorSpeak(true); };

    function openSingleDocEditor(kind){
      const para = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
      const pid  = `${CURRENT.book}|${CURRENT.chap}|${para.ref}`;

      const titlePrefix =
        kind==='unit'       ? 'ë‹¨ìœ„ì„±ê²½ì† ë§¥ë½' :
        kind==='whole'      ? 'ì „ì²´ì„±ê²½ì† ë§¥ë½' :
        kind==='commentary' ? 'ì£¼ì„' :
                              'ë‚´ìš©ìš”ì•½';

      const key = 
        kind==='unit'       ? STORAGE_UNIT_CTX :
        kind==='whole'      ? STORAGE_WHOLE_CTX :
        kind==='commentary' ? STORAGE_COMMENTARY :
                              STORAGE_SUMMARY;

      const map = getDocMap(key);
      const doc = map[pid] || {
        title: `${titlePrefix} â€” ${para.title||para.ref}`,
        body:  (kind==='summary' ? 'í•µì‹¬ ë‚´ìš©ì„ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ ì ì–´ì£¼ì„¸ìš”.' : ''),
        images: [], date:''
      };

      modalRef.textContent = `${CURRENT.book} ${CURRENT.chap}ì¥ Â· ${para.title||para.ref} (${para.ref}) â€” ${titlePrefix}`;
      sermonList.innerHTML = '';
      sermonEditor.style.display = '';
      sermonEditor.classList.add('context-editor');
      modalWrap.style.display = 'flex';
      modalWrap.setAttribute('aria-hidden','false');
      modalFooterNew.style.display = 'none';

      sermonTitle.value = doc.title || '';
      setBodyHTML(doc.body || '');

      sermonThumbs.innerHTML = '';
      (doc.images||[]).forEach(src=>{ const img=new Image(); img.src=src; sermonThumbs.appendChild(img); });

      sermonEditor.dataset.editing = '';
      sermonEditor.dataset.ctxType = kind;
      // === [AIë¡œ ì±„ìš°ê¸°] ë²„íŠ¼ í‘œì‹œ/ë¹„í‘œì‹œ ë° í´ë¦­ í•¸ë“¤ëŸ¬ ===
      const aiBtn = document.getElementById('aiFill');
      if (aiBtn) {
        aiBtn.style.display = (kind === 'unit') ? '' : 'none';

        // ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì œê±° í›„ ì¬ë°”ì¸ë”©(ë‹¤ë¥¸ kindì—ì„œ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆì–´ìš”)
        aiBtn.onclick = null;

        if (kind === 'unit') {
          aiBtn.onclick = async ()=> {
            try{
              aiBtn.disabled = true;
              aiBtn.textContent = 'AI ìƒì„± ì¤‘â€¦';

              const para = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
              const payload = {
                kind: 'unit',
                book: CURRENT.book,
                chapter: CURRENT.chap,
                ref: para.ref,
                title: para.title || '',
                verses: (para.verses || []).map(([v,t]) => ({ verse: v, text: t })),
              };

              const res = await fetch(AI_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify(payload)
              });
              if(!res.ok){
                const msg = await res.text().catch(()=> '');
                throw new Error(`AI ì‘ë‹µ ì˜¤ë¥˜(${res.status}) ${msg}`);
              }
              const data = await res.json(); // { ok:true, text:"..." }
              if(!data || !data.text) throw new Error('AI ì‘ë‹µì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.');

              // ë³¸ë¬¸ì— ì£¼ì…(ë®ì–´ì“°ê¸°; ê¸°ì¡´ ë‚´ìš© ë³´ì¡´í•˜ë ¤ë©´ ì•„ë˜ ì¤„ì„ ì£¼ì„ ì²˜ë¦¬í•˜ê³  append ë°©ì‹ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”)
              // sermonBody.value = data.text.trim();

              setBodyHTML(data.text.trim());

              // ğŸ‘‰ ì´ì–´ë¶™ì´ê¸°ë¥¼ ì›í•˜ì‹œë©´ ì•„ë˜ ì£¼ì„ í•´ì œí•˜ê³  ìœ„ ì¤„ ì£¼ì„ ì²˜ë¦¬:
              // sermonBody.value = (sermonBody.value.trim() ? sermonBody.value.trim() + '\n\n' : '') + data.text.trim();

              status('AIê°€ ë‹¨ìœ„ì„±ê²½ì† ë§¥ë½ì„ ì±„ì› ìŠµë‹ˆë‹¤.');
            }catch(err){
              console.error(err);
              alert('AI ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + (err?.message||err));
            }finally{
              aiBtn.disabled = false;
              aiBtn.textContent = 'AIë¡œ ì±„ìš°ê¸°';
            }
          };
        }
      }

    }

    function renderSermonList(){
      const map = getSermonMap();
      const arr = map[CURRENT.paraId] || [];
      sermonList.innerHTML = '';
      if(arr.length===0){ startNewSermon(); return; }

      arr.forEach((it, idx)=>{
        const row = document.createElement('div'); row.className='item';
        const dateHtml = it.date ? `<span class="date">${it.date}</span>` : '';
        row.innerHTML = `
          <div class="item-title">
            ${escapeHtml(it.title||'(ì œëª© ì—†ìŒ)')} ${dateHtml}
          </div>
          <div class="ptoolbar">
            <button data-edit="${idx}">í¸ì§‘</button>
            <button data-del="${idx}" style="border-color:var(--danger);color:var(--text)">ì‚­ì œ</button>
          </div>`;
        row.querySelector('[data-edit]').onclick = ()=>{
          modalWrap.style.display = 'none'; modalWrap.setAttribute('aria-hidden','true');
          openSermonEditorWindow(idx);
        };
        row.querySelector('[data-del]').onclick = ()=> deleteSermon(idx);
        sermonList.appendChild(row);
      });
    }

el('newSermonBtn').onclick = ()=>{
  // ì»¨í…ìŠ¤íŠ¸ í¸ì§‘ ìƒíƒœê°€ ë‚¨ì•„ ìˆì–´ë„ ë¬´ì‹œí•˜ê³  ì„¤êµ ëª¨ë“œë¡œ ê°•ì œ ì „í™˜
  sermonEditor.dataset.ctxType = '';

  // í˜„ì¬ ë‹¨ë½ ì‹ë³„ì ë³´ì¥
  if (!CURRENT.paraId) {
    if (!syncCurrentFromOpen()) {
      alert('ë‹¨ë½ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
      return;
    }
    const para = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
    CURRENT.paraId = `${CURRENT.book}|${CURRENT.chap}|${para.ref}`;
  }

  // ìƒˆ ì„¤êµ í•­ëª© ì¶”ê°€
  const map = getSermonMap();
  const arr = map[CURRENT.paraId] || [];
  const newId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
  arr.unshift({ id: newId, title:'', body:'', images:[], date:'' });
  map[CURRENT.paraId] = arr;
  setSermonMap(map);

  // ëª¨ë‹¬ ë‹«ê³  ì²« í•­ëª© í¸ì§‘ íŒì—… ì—´ê¸°
  modalWrap.style.display='none';
  modalWrap.setAttribute('aria-hidden','true');
  openSermonEditorWindow(0);
};

    function startNewSermon(){
      sermonList.innerHTML = '<div class="muted" style="padding:0 14px">ìƒˆ ì„¤êµë¥¼ ì‘ì„±í•´ ì €ì¥í•˜ë©´ ì´ ë‹¨ë½ì— ë¶™ìŠµë‹ˆë‹¤.</div>';
      sermonEditor.classList.add('context-editor');
      sermonEditor.style.display = '';
      sermonTitle.value = ''; sermonBody.value = ''; sermonThumbs.innerHTML = ''; sermonImages.value = '';
      sermonEditor.dataset.editing = '';
      stopEditorSpeak(true);
    }
    function editSermon(idx){
      const map = getSermonMap(); const arr = map[CURRENT.paraId] || []; const it = arr[idx]; if(!it) return;
      sermonEditor.classList.add('context-editor');
      sermonEditor.style.display = ''; sermonEditor.dataset.editing = String(idx);
      sermonTitle.value = it.title||''; sermonBody.value = it.body||''; sermonThumbs.innerHTML = '';
      (it.images||[]).forEach(src=>{ const img=new Image(); img.src=src; sermonThumbs.appendChild(img); });
      stopEditorSpeak(true);
    }
    function deleteSermon(idx){
      if(!confirm('ì´ ì„¤êµë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
      const map = getSermonMap(); const arr = map[CURRENT.paraId] || [];
      arr.splice(idx,1); map[CURRENT.paraId] = arr; setSermonMap(map); renderSermonList();
    }

    el('cancelEdit').onclick = ()=>{
      if(sermonEditor.dataset.ctxType){
        sermonEditor.dataset.ctxType = '';
        modalWrap.style.display = 'none'; modalWrap.setAttribute('aria-hidden','true');
      }else{
        sermonEditor.style.display = 'none'; renderSermonList();
      }
      stopEditorSpeak(true);
    };

    el('saveSermon').onclick = ()=>{
      sermonBody.value=stripBlankLines(sermonBody.value);
      const title = sermonTitle.value.trim() || '(ì œëª© ì—†ìŒ)';
      // const body  = sermonBody.value.trim();

      // ê°œí–‰, <br> ë³´ì¡´ ë²„ì „
      let body = getBodyHTML() || '';
      // í•„ìš” ì‹œ ì•ë’¤ ê³µë°±ë§Œ ì œê±°í•˜ë˜ ë‚´ë¶€ ê°œí–‰ì€ ìœ ì§€
      body = body.replace(/^\s+|\s+$/g, '');

      const imgs  = [...sermonThumbs.querySelectorAll('img')].map(img=>img.src);
      const now   = new Date();
      const date  = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

      const para  = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
      const pid   = `${CURRENT.book}|${CURRENT.chap}|${para.ref}`;
      const ctxType = sermonEditor.dataset.ctxType || '';

      if(ctxType){
        const key = ctxType==='unit'       ? STORAGE_UNIT_CTX
                  : ctxType==='whole'      ? STORAGE_WHOLE_CTX
                  : ctxType==='commentary' ? STORAGE_COMMENTARY
                  :                          STORAGE_SUMMARY;
        const map = getDocMap(key);
        map[pid] = { title, body, images: imgs, date };
        setDocMap(key, map);

        sermonEditor.dataset.ctxType = '';
        sermonEditor.classList.remove('context-editor');
        modalWrap.style.display = 'none'; modalWrap.setAttribute('aria-hidden','true');
        status(`ì €ì¥ë¨: ${title}`);
        return;
      }

      const map = getSermonMap();
      const arr = map[CURRENT.paraId] || [];
      const editing = sermonEditor.dataset.editing;
      if(editing!==''){ const i=+editing; if(arr[i]) arr[i] = {...arr[i], title, body, images:imgs, date}; }
      else { arr.unshift({ id: crypto.randomUUID(), title, body, images: imgs, date }); }
      map[CURRENT.paraId] = arr; setSermonMap(map);
      sermonEditor.style.display = 'none'; renderSermonList(); status('ì„¤êµê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    sermonImages.addEventListener('change', async ()=>{
      const files = [...sermonImages.files||[]];
      for(const f of files){ const data = await fileToDataURL(f); const img = new Image(); img.src = data; sermonThumbs.appendChild(img); }
      sermonImages.value = '';
    });

    /* ===== RTE ìœ í‹¸ (ëª¨ë‹¬ í¸ì§‘ê¸°ìš©) ===== */
    function isRTE(){ return sermonBody && sermonBody.getAttribute('contenteditable') === 'true'; }
    function getBodyHTML(){ return isRTE() ? sermonBody.innerHTML : (sermonBody.value || ''); }
    function setBodyHTML(html){ if(isRTE()) sermonBody.innerHTML = html || ''; else sermonBody.value = html || ''; }

    // ì„ íƒ ì˜ì—­ì— ìƒ‰ ì¦‰ì‹œ ì ìš© (ì„ íƒ ì—†ìœ¼ë©´ caretì— span ì‚½ì…)
    function applyColorImmediateToRTE(hex){
      if(!isRTE()) return;
      const sel = window.getSelection();
      if(!sel || sel.rangeCount===0){ sermonBody.focus(); return; }
      const range = sel.getRangeAt(0);
      if(!sermonBody.contains(range.commonAncestorContainer)){ sermonBody.focus(); return; }

      if(range.collapsed){
        const sp = document.createElement('span');
        sp.style.color = hex;
        sp.appendChild(document.createTextNode('\u200B')); // zero-width space
        range.insertNode(sp);
        sel.removeAllRanges();
        const r = document.createRange();
        r.setStart(sp.firstChild, 1); r.collapse(true);
        sel.addRange(r);
        return;
      }
      document.execCommand('foreColor', false, hex);
    }
    function execFmt(cmd){
      if(isRTE()){
        sermonBody.focus({preventScroll:true});
        document.execCommand(cmd,false,null);
      }
    }


    /* --------- Editor TTS --------- */
    editorSpeakBtn.onclick = ()=> toggleEditorSpeak();
    function toggleEditorSpeak(){
      const tmp = document.createElement('div'); tmp.innerHTML = getBodyHTML();
      tmp.querySelectorAll('sup').forEach(s=> s.textContent='['+s.textContent+'] ');
      const plain = (tmp.textContent||'').replace(/\n{2,}/g,' ').replace(/\s+/g,' ').trim();
      const text = [sermonTitle.value.trim(), plain].filter(Boolean).join('. ');
      if(!EDITOR_READER.synth) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      if(EDITOR_READER.playing){ stopEditorSpeak(); return; }

      if(!text){ alert('ë‚­ë…í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const u = new SpeechSynthesisUtterance(text.replace(/\n{2,}/g, '. ').replace(/\n/g,' '));
      applyVoice(u); u.onend = ()=> stopEditorSpeak(true);
      EDITOR_READER.u = u; EDITOR_READER.synth.cancel(); EDITOR_READER.synth.speak(u);
      EDITOR_READER.playing = true; editorSpeakBtn.textContent = 'ì¤‘ì§€';
    }
    function stopEditorSpeak(silent){
      if(EDITOR_READER.synth){ try{ EDITOR_READER.synth.cancel(); }catch(e){} }
      EDITOR_READER.playing = false; EDITOR_READER.u = null;
      if(!silent) status('ì„¤êµ ë‚­ë…ì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.'); editorSpeakBtn.textContent = 'ë‚­ë…';
    }

    /* --------- Hotkeys --------- */
    window.addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='s'){
        e.preventDefault();
        downloadBibleJSON();
        return;
      }
      if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      const key = e.key.toLowerCase();
      if(key === 's'){
        e.preventDefault();
        syncCurrentFromOpen();
        const openPara = treeEl.querySelector('details.para[open]');
        if(openPara && CURRENT.book!=null){
          const btn = openPara.querySelector('.speakBtn');
          toggleSpeakInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx, openPara, btn);
        }
        return;
      }
      if(key === 'n'){
        e.preventDefault();
        if(!syncCurrentFromOpen()) return;
        const wasPlaying = !!READER.playing;
        try{ READER.synth && READER.synth.cancel(); }catch(_){}
        if (READER._wd){ clearTimeout(READER._wd); READER._wd = null; }
        READER.playing = wasPlaying;
        const moved = goToNextParagraphInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
        if(!moved) return;
        if (wasPlaying){
          const cb = READER.scope?.querySelector?.('.keepReading');
          if(cb){ cb.checked = READER.continuous; cb.disabled = false; }
          READER.q   = buildQueueFrom(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
          READER.idx = 0;
          bindKeepReading(READER.scope);
          updateInlineSpeakBtn();
          setTimeout(()=>{ try{ READER.synth && READER.synth.cancel(); }catch(_){}
            playNextInQueueInline(CURRENT.book, CURRENT.chap, CURRENT.paraIdx);
          }, 120);
        }
      }
    });

/* êµì²´ë³¸ â€” í° ì œëª© ì…ë ¥ë€(2ë°°), ìë™ì €ì¥, ë³¸ë¬¸ì ˆ ì‚½ì…, ì„±ê²½êµ¬ì ˆ(ì•½ì–´ ì§€ì›),
   bible_paragraphs.json ìš°ì„  ë¡œë“œ, ê¸€ììŠ¤íƒ€ì¼/ìƒ‰/pxí¬ê¸°, A4 ì¸ì‡„,
   â¬‡ï¸ì‚½ì…ëœ ì„±ê²½êµ¬ì ˆì„ ê¸°ìš¸ì„+ë°ì€ ë°œê°•ìƒ‰ìœ¼ë¡œ í‘œì‹œ(í´ë˜ìŠ¤ ê¸°ë°˜) */
function openSermonEditorWindow(idx){
  const map = getSermonMap();
  const arr = map[CURRENT.paraId] || [];
  const it  = arr[idx];
  if(!it){ alert('í¸ì§‘í•  ì„¤êµë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

  const para = BIBLE.books[CURRENT.book][CURRENT.chap].paras[CURRENT.paraIdx];
  const versesRaw = Array.isArray(para?.verses) ? para.verses : [];

  const meta = {
    paraId: CURRENT.paraId,
    idx,
    ref: `${CURRENT.book} ${CURRENT.chap}ì¥ Â· ${(para?.title || para?.ref || '')} (${para?.ref || ''})`,
    title: it.title || '',
    body:  it.body  || '',
    images: it.images || [],
    date: it.date || '',
    verses: versesRaw
  };

  const w = window.open('', '_blank', 'width=1100,height=820');
  if(!w){ alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.'); return; }
  w.__WBPS_META__ = meta;

  const popupHTML = String.raw`<!DOCTYPE html><html lang="ko">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ì„¤êµ í¸ì§‘</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&family=Nanum+Myeongjo&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1115;--panel:#161922;--text:#e6e8ef;--muted:#9aa0ab;--border:#252a36;--accent:#6ea8fe;--danger:#ff6b6b}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);display:grid;grid-template-rows:56px 1fr 56px;gap:8px}
header,footer{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--panel);border-bottom:1px solid var(--border)}
footer{border-top:1px solid var(--border);border-bottom:none}
.grow{flex:1 1 auto}
main{padding:0 12px 12px}

input[type="text"].title-input{
  width:50%;               /* í­: í•„ìš”ì‹œ ì¡°ì ˆ ê°€ëŠ¥ (70~90%) */
  max-width:500px;
  background:#161922;
  color:#e6e8ef;
  border:1px solid #2a3040;
  border-radius:8px;
  padding:0;
  font-weight:600;
  font-size:1.1rem;
  line-height:1.4;
  letter-spacing:0.01em;
  box-shadow:0 3px 8px rgba(0,0,0,.15);
  box-sizing:border-box;
  margin: 0;               /* âœ… ëª¨ë“  ì—¬ë°± ì œê±° */
  text-align:left;         /* âœ… í…ìŠ¤íŠ¸ ì™¼ìª½ ì •ë ¬ */
  display:block;           /* âœ… ì¤„ ì „ì²´ ì°¨ì§€ */
}

input#t.title-input::placeholder{
  color:rgba(230,232,239,.6);
  opacity:1;              /* Firefox */
}

/* í¬ë¡¬ ìë™ì™„ì„± ì‹œ ê¸€ì/ë°°ê²½ ë³´ì • */
input#t.title-input:-webkit-autofill,
input#t.title-input:-webkit-autofill:hover,
input#t.title-input:-webkit-autofill:focus{
  -webkit-text-fill-color:#e6e8ef !important;
  box-shadow:0 0 0 1000px #161922 inset !important;
  transition: background-color 9999s;
}

.toolbar{display:flex;gap:6px;flex-wrap:wrap;align-items:center;background:color-mix(in hsl,var(--panel) 85%,black 6%);border:1px solid var(--border);border-radius:10px;padding:6px 8px;margin-top:10px}
.toolbar .sep{width:1px;height:22px;background:var(--border);margin:0 4px}
.pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:color-mix(in hsl,var(--panel) 85%,black 6%);padding:4px 6px;border-radius:8px}

.rte{min-height:56vh;margin-top:8px;padding:14px;background:#161922;border:1px solid #2a3040;border-radius:10px;line-height:1.85;letter-spacing:.015em;caret-color:var(--accent);outline:none;box-shadow:0 6px 16px rgba(0,0,0,.18)}
.rte sup{color:#9fb7ff;font-weight:700;margin-right:4px}

button{background:color-mix(in hsl,var(--panel) 65%,black 10%);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:6px 10px;cursor:pointer;transition:border-color .15s,transform .04s}
button:hover{border-color:color-mix(in hsl,var(--border) 75%,var(--accent) 25%)}
button:active{transform:translateY(1px)}
.primary{background:linear-gradient(180deg,color-mix(in srgb,var(--accent) 78%,white 10%),color-mix(in srgb,var(--accent) 72%,black 22%));border-color:color-mix(in srgb,var(--accent) 70%,black 10%)}
.danger{border-color:var(--danger);color:#ffd7d7;background:transparent}
.muted{color:var(--muted)}
.color{width:32px;height:28px;padding:0;border-radius:8px}
input[type="number"]{width:74px;background:#161922;color:#e6e8ef;border:1px solid var(--border);border-radius:6px;padding:2px 8px}

.thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.thumbs img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}

/* ì¸ì‡„ ìµœì í™” */
@media print {
  @page { size: A4; margin: 18mm; }
  body{ background:#fff; color:#000; grid-template-rows:0 1fr 0 }
  header, footer, .toolbar { display:none !important; }
  .rte{ border:none; box-shadow:none; padding:0; min-height:auto }
}

/* ë³¸ë¬¸ íƒ€ì´í¬ */
.context-editor{font-family:"Noto Serif KR","Nanum Myeongjo",serif;font-size:1.05rem;line-height:1.85;letter-spacing:.02em;word-break:keep-all}
.context-editor em,.context-editor i{font-style:italic}
.context-editor strong,.context-editor b{
  font-weight:700;
}
.context-editor u{text-decoration:underline}
.context-editor s,.context-editor strike{text-decoration:line-through}

/* â¬‡ï¸ ì‚½ì…ëœ ì„±ê²½êµ¬ì ˆ ìŠ¤íƒ€ì¼(ê¸°ìš¸ì„ + ë°ì€ ë°œê°•ìƒ‰) */
.rte .verse-header{ color:#ff9090; font-style:italic; font-weight:600; }
.rte .verse-line{   color:#ffb3b3; font-style:italic; }
.rte .verse-line sup{ color:#ffd1d1; font-style:italic; }

/* ===== íŒì—… í¸ì§‘ì°½: ë³¸ë¬¸(#b)ë§Œ ìŠ¤í¬ë¡¤ ===== */
main{
  display:flex;
  flex-direction:column;
  overflow:hidden;           /* main ìì²´ ìŠ¤í¬ë¡¤ ê¸ˆì§€ */
}
.rte{                        /* #bì— ë¶™ì€ í´ë˜ìŠ¤ */
  flex:1 1 auto;
  min-height:0;              /* flex ì•ˆì—ì„œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
  overflow:auto;             /* ë³¸ë¬¸ë§Œ ìŠ¤í¬ë¡¤ */
}
/* íˆ´ë°” ê³ ì • */
.toolbar{
  position: sticky;
  top: 0;
  z-index: 10;
  background: color-mix(in hsl,var(--panel) 85%,black 6%);
  border-bottom: 1px solid var(--border);
}

/* ë„êµ¬ì˜ì—­ ì ‘ê¸°/í¼ì¹˜ê¸° */
.controls-wrap{
  overflow:hidden;
  transition:max-height .25s ease, opacity .25s ease;
  max-height:600px; opacity:1;
}
.controls-wrap.collapsed{
  max-height:0;
  opacity:0;
}
#toggleControlsBtn{ min-width:96px }
 
</style>
</head>
<body class="context-editor">
<header>
  <strong>ì„¤êµ í¸ì§‘</strong><span class="muted" id="ref"></span>
  <div class="grow"></div>
  <button id="x">ë‹«ê¸°</button>
</header>
<main>
 <div id="controlsWrap" class="controls-wrap collapsed">
  <input id="t" class="title-input" type="text" autocomplete="off" placeholder="ì„¤êµ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
  <div class="toolbar">
    <button id="btnBold"><b>êµµê²Œ</b></button>
    <button id="btnItalic"><i>ê¸°ìš¸ì„</i></button>
    <button id="btnUnderline"><u>ë°‘ì¤„</u></button>
    <button id="btnStrike"><s>ì·¨ì†Œì„ </s></button>
    <span class="sep"></span>
    <label class="pill"><span class="muted">ê¸€ììƒ‰</span><input id="color" class="color" type="color" value="#ffffff"><button id="btnColor">ì ìš©</button></label>
    <span class="sep"></span>
    <label class="pill">
      <span class="muted">ê¸€ê¼´(px)</span>
      <input id="fontSizePx" type="number" min="10" max="64" step="1" value="16">
      <button id="btnFontSizeApply">ì ìš©</button>
    </label>
    <span class="sep"></span>
    <button id="btnInsAllVerses">ë³¸ë¬¸ì ˆ(ì „ì²´)</button>
    <button id="btnInsSelVerses">ë³¸ë¬¸ì ˆ(ì„ íƒ)</button>
    <button id="btnInsertBible">ì„±ê²½êµ¬ì ˆ</button>
    <span class="muted" id="draftState">ìë™ì €ì¥</span>
    <span class="sep"></span>
  </div>
 </div>
  <div id="b" class="rte" contenteditable="true" spellcheck="false"></div>
  <div class="thumbs" id="th"></div>
  <input type="file" id="imgs" accept="image/*" multiple style="margin-top:4px">
</main>
<footer>
  <span class="muted" id="date"></span><div class="grow"></div>
  <button id="print">ì¸ì‡„(A4)</button>
  <button id="read" class="primary">ë‚­ë…</button>
  <button id="stop">ì¤‘ì§€</button>
  <button class="danger" id="d">ì‚­ì œ</button>
  <button class="primary" id="s">ì €ì¥</button>
</footer>
</body></html>`;

  w.document.open(); w.document.write(popupHTML); w.document.close();

w.addEventListener('load', () => {
  const meta = w.__WBPS_META__ || {};
  const $ = id => w.document.getElementById(id);

  const t=$('t'), b=$('b'), th=$('th'), imgs=$('imgs');
  const refEl=$('ref'), dateEl=$('date'), draftState=$('draftState');

  // ğŸ”¹ ì œëª© / ë³¸ë¬¸ / ì´ë¯¸ì§€ ì´ˆê¸° ì£¼ì…
  t.value = meta.title || '';
  refEl.textContent = ' â€” ' + (meta.ref || '');
  dateEl.textContent = meta.date ? ('ìµœê·¼ ì €ì¥: ' + meta.date) : '';

  // ğŸ”¹ ë³¸ë¬¸ ë¡œë“œ(HTMLì´ë©´ ê·¸ëŒ€ë¡œ, í…ìŠ¤íŠ¸ë©´ <p>ë¡œ ë³€í™˜)
  if (/<\/?[a-z][\s\S]*>/i.test(meta.body||'')) {
    b.innerHTML = meta.body;
  } else {
    const safe = String(meta.body||'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    b.innerHTML = safe.split(/\r?\n/)
      .filter(x=>x.trim()!=='')
      .map(p=>`<p>${p}</p>`).join('') || '<p></p>';
  }

  // ğŸ”¹ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
  th.innerHTML = '';
  (meta.images||[]).forEach(src=>{
    const im=new w.Image();
    im.src=src;
    th.appendChild(im);

// == í¸ì§‘í•˜ê¸° (ë„êµ¬ ì˜ì—­ í¼ì¹˜ê¸°) ==
// == í¸ì§‘í•˜ê¸° ë²„íŠ¼ìœ¼ë¡œ ë„êµ¬ ì˜ì—­ í¼ì¹˜ê¸° ==
(function(){
  const wrap = w.document.getElementById('controlsWrap');
  const btn  = w.document.getElementById('toggleControlsBtn');
  if(!wrap || !btn) return;
  const KEY = 'wbps.popup.controls.collapsed';

  // ê¸°ë³¸ì€ ì ‘í˜€ ìˆìŒ
  wrap.classList.add('collapsed');
  btn.textContent = 'í¸ì§‘í•˜ê¸°';

  // ì €ì¥ëœ ìƒíƒœ ë³µì›
  if(localStorage.getItem(KEY)==='0'){
    wrap.classList.remove('collapsed');
    btn.textContent = 'ë„êµ¬ ë‹«ê¸°';
  }

  // í´ë¦­ ì‹œ í† ê¸€
  btn.addEventListener('click', ()=>{
    const collapsed = wrap.classList.toggle('collapsed');
    btn.textContent = collapsed ? 'í¸ì§‘í•˜ê¸°' : 'ë„êµ¬ ë‹«ê¸°';
    localStorage.setItem(KEY, collapsed ? '1' : '0');
  });
})();

// ===== ì¸ì‡„(A4) ë²„íŠ¼ =====
const printBtn = w.document.getElementById('print');
if (printBtn) {
  printBtn.addEventListener('click', () => {
    // A4 ê¸°ë³¸ ì„¤ì •ìš© CSSë¥¼ ì¶”ê°€
    const style = w.document.createElement('style');
    style.textContent = `
      @media print {
        @page { size: A4 portrait; margin: 20mm; }
        body { background: white; color: black; }
        header, #toggleControlsBtn { display: none !important; }
        .toolbar, .thumbs, #imgs { display: none !important; }
        #b.rte { border:none !important; box-shadow:none !important; }
      }
    `;
    w.document.head.appendChild(style);

    // ë¸Œë¼ìš°ì € ì¸ì‡„ì°½ ì—´ê¸°
    w.print();
  });
}


    
  });

  // ğŸ”¹ ë‚­ë… / ì¤‘ì§€
  $('read').onclick = ()=>{
    const txt = [(t.value||'').trim(), toPlainText(b.innerHTML).trim()]
      .filter(Boolean).join('. ');
    if(!txt){ w.alert('ë‚­ë…í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
    const synth = w.speechSynthesis || window.speechSynthesis;
    try{ synth.cancel(); }catch(_){}
    const u = new w.SpeechSynthesisUtterance(txt);
    u.lang='ko-KR';
    synth.speak(u);
  };
  $('stop').onclick = ()=>{ try{ (w.speechSynthesis||window.speechSynthesis)?.cancel(); }catch(_){} };

  // ğŸ”¹ ê¸€ì ìŠ¤íƒ€ì¼ ë²„íŠ¼
  const exec=(cmd,val=null)=>w.document.execCommand(cmd,false,val);
  $('btnBold').onclick=()=>exec('bold');
  $('btnItalic').onclick=()=>exec('italic');
  $('btnUnderline').onclick=()=>exec('underline');
  $('btnStrike').onclick=()=>exec('strikeThrough');
  $('btnColor').onclick=()=>exec('foreColor',$('color').value || '#ffffff');

  // ğŸ”¹ í°íŠ¸ í¬ê¸°(px)
  const fontPx=$('fontSizePx');
  $('btnFontSizeApply').onclick=()=>{
    const px=parseInt(fontPx.value,10);
    if(!px || px<10 || px>64){ w.alert('10~64px ì‚¬ì´ë¡œ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    applyFontSizeToSelection(px);
  };

  function applyFontSizeToSelection(px){
    const sel = w.getSelection();
    if(!sel || sel.rangeCount===0){ b.focus(); return; }
    const range = sel.getRangeAt(0);
    if(!b.contains(range.commonAncestorContainer)){ b.focus(); return; }

    if(range.collapsed){
      const sp = w.document.createElement('span');
      sp.style.fontSize = px + 'px';
      sp.appendChild(w.document.createTextNode('\u200B'));
      range.insertNode(sp);
      sel.removeAllRanges();
      const r = w.document.createRange();
      r.setStart(sp.firstChild, 1); r.collapse(true);
      sel.addRange(r);
      scheduleDraft(); return;
    }
    const frag = range.cloneContents();
    wrapTextNodes(frag, px);
    const div = w.document.createElement('div');
    div.appendChild(frag);
    w.document.execCommand('insertHTML', false, div.innerHTML);
    const ns = w.getSelection(); ns && ns.collapseToEnd();
    scheduleDraft();
  }

  // ì„ íƒ ì˜ì—­ì— ìƒ‰ ì¦‰ì‹œ ì ìš© (ì„ íƒ ì—†ìœ¼ë©´ caretì— span ì‚½ì…)
  function applyColorImmediate(hex){
    const sel = w.getSelection();
    if(!sel || sel.rangeCount===0){ b.focus(); return; }
    const range = sel.getRangeAt(0);
    if(!b.contains(range.commonAncestorContainer)){ b.focus(); return; }

    if(range.collapsed){
      const sp = w.document.createElement('span');
      sp.style.color = hex;
      sp.appendChild(w.document.createTextNode('\u200B')); // zero-width space
      range.insertNode(sp);
      sel.removeAllRanges();
      const r = w.document.createRange();
      r.setStart(sp.firstChild, 1); r.collapse(true);
      sel.addRange(r);
      scheduleDraft();
      return;
    }
    // ì„ íƒëœ ë‚´ìš©ì´ ìˆìœ¼ë©´ foreColorë¡œ ì²˜ë¦¬(ë¸Œë¼ìš°ì € í•©ì„± ì‚¬ìš©)
    w.document.execCommand('foreColor', false, hex);
    scheduleDraft();
  }



  // ===== Alt ë‹¨ì¶•í‚¤ (b/i/u/e/c/f) : ì„¤êµ í¸ì§‘ ë³¸ë¬¸(#b) ì „ìš© =====
  // ===== Alt ë‹¨ì¶•í‚¤ (b/i/u/e/c/f) : ì„¤êµ í¸ì§‘ ë³¸ë¬¸(#b) ì „ìš© =====
  (function initEditorHotkeys(){
    const colorInput = $('color'); // ì´ë¯¸ toolbarì— ì¡´ì¬

    function selectionInsideBody(){
      const sel = w.getSelection();
      if(!sel || sel.rangeCount===0) return false;
      const node = sel.getRangeAt(0).commonAncestorContainer;
      return b.contains(node.nodeType === 3 ? node.parentNode : node);
    }

    w.addEventListener('keydown', (e) => {
      // Alt ì¡°í•©ë§Œ í—ˆìš© (Ctrl/Meta ì„ì´ë©´ ë¬´ì‹œ)
      if (!e.altKey || e.ctrlKey || e.metaKey) return;

      // í¬ì»¤ìŠ¤ê°€ ë³¸ë¬¸(#b) ì•ˆì— ìˆì„ ë•Œë§Œ ë™ì‘
      const active = w.document.activeElement;
      const isBodyFocused = (active === b) || b.contains(active) || selectionInsideBody();
      if (!isBodyFocused) return;

      const k = (e.key || '').toLowerCase();
      if (!['b','i','u','e','c','f'].includes(k)) return;

      e.preventDefault();
      e.stopPropagation();

      switch(k){
        case 'b': exec('bold'); break;
        case 'i': exec('italic'); break;
        case 'u': exec('underline'); break;
        case 'e': exec('strikeThrough'); break;

        case 'c': { // Alt + C : ìƒ‰ ì¦‰ì‹œ ì ìš©
          const hex = (colorInput && colorInput.value) ? colorInput.value : '#ffffff';
          applyColorImmediate(hex);
          break;
        }

        case 'f': { // Alt + F : ê¸€ê¼´ í¬ê¸° ì¦‰ì‹œ ì ìš©
          const fontPxInput = $('fontSizePx');
          const px = parseInt(fontPxInput && fontPxInput.value, 10);
          if (!isNaN(px) && px >= 10 && px <= 64) {
            applyFontSizeToSelection(px);
          } else {
            w.alert('ê¸€ê¼´(px)ì€ 10~64 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          }
          break;
        }
      }
    }, true);
  })();


  function wrapTextNodes(root, px){
    const walker = w.document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
      acceptNode(n){ return n.nodeValue.trim() ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT; }
    });
    let node; const list=[];
    while((node=walker.nextNode())) list.push(node);
    list.forEach(n=>{
      const sp=w.document.createElement('span');
      sp.style.fontSize=px+'px';
      n.parentNode.replaceChild(sp,n);
      sp.appendChild(n);
    });
  }

  // ğŸ”¹ ë³¸ë¬¸ì ˆ ì‚½ì…(í˜„ì¬ ë‹¨ë½)
  const insertHTML = (html)=>{ b.focus(); w.document.execCommand('insertHTML', false, html); };
  $('btnInsAllVerses').onclick=()=>{
    const html=(meta.verses||[]).map(([v,t])=>`<div class="verse-line"><sup>${v}</sup>${t}</div>`).join('');
    insertHTML(html || '<div>(ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤)</div>');
    scheduleDraft();
  };
  $('btnInsSelVerses').onclick=()=>{
    const q=w.prompt('ì‚½ì…í•  ì ˆ (ì˜ˆ: 1-3,5,8)'); if(!q) return;
    const set=new Set();
    String(q).split(',').map(x=>x.trim()).forEach(tok=>{
      const m=tok.match(/^(\d+)\s*-\s*(\d+)$/);
      if(m){ let a=+m[1], b=+m[2]; if(a>b)[a,b]=[b,a]; for(let i=a;i<=b;i++) set.add(i); }
      else { const v=+tok; if(!isNaN(v)) set.add(v); }
    });
    const picked=(meta.verses||[]).filter(([v])=>set.has(+v));
    if(!picked.length){ w.alert('í•´ë‹¹ ì ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
    insertHTML(picked.map(([v,t])=>`<div class="verse-line"><sup>${v}</sup>${t}</div>`).join(''));
    scheduleDraft();
  };

  // ğŸ”¹ ì„±ê²½ ë°ì´í„° ë¡œë“œ (bible_paragraphs.json ìš°ì„ )
  let __BOOKS_CACHE = null;
  async function getBooksInPopup(){
    if (__BOOKS_CACHE) return __BOOKS_CACHE;
    try{
      const P = w.opener || window.opener;
      if (P && P.BIBLE && P.BIBLE.books){
        __BOOKS_CACHE = P.BIBLE.books;
        return __BOOKS_CACHE;
      }
    }catch(_){}
    async function tryLoad(path){
      try{
        const res = await fetch(path, {cache:'no-store'});
        if(!res.ok) return null;
        const j = await res.json();
        return j && j.books ? j.books : null;
      }catch(_){ return null; }
    }
    __BOOKS_CACHE = await tryLoad('bible_paragraphs.json') || await tryLoad('bible-paragraph.json');
    if(!__BOOKS_CACHE) throw new Error('ì„±ê²½ ë°ì´í„°(BIBLE)ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return __BOOKS_CACHE;
  }

  // ğŸ”¹ ì„±ê²½êµ¬ì ˆ ì‚½ì…
  $('btnInsertBible').onclick = async ()=>{
    const raw=w.prompt('ì‚½ì…í•  ì„±ê²½êµ¬ì ˆ (ì˜ˆ: ìš”í•œë³µìŒ 3:16, ìš”1 3:16, ì°½ì„¸ê¸° 1:1-3)'); if(!raw) return;
    const norm=String(raw).replace(/\s+/g,' ').replace(/[â€“â€”ï¼]/g,'-').replace(/[ï¼š]/g,':').trim();
    const m=norm.match(/^(.+?)\s+(\d+)\s*:\s*(\d+)(?:\s*-\s*(\d+))?$/);
    if(!m){ w.alert('í˜•ì‹: ì„±ê²½ì´ë¦„ ì¥:ì ˆ ë˜ëŠ” ì¥:ì ˆ-ì ˆ'); return; }
    const bookRaw=m[1], chap=parseInt(m[2],10), vFrom=parseInt(m[3],10), vTo=m[4]?parseInt(m[4],10):parseInt(m[3],10);

    let BOOKS;
    try{ BOOKS = await getBooksInPopup(); }
    catch(e){ w.alert(e.message || 'ì„±ê²½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

    const bookKey=resolveBookKey(bookRaw,BOOKS);
    if(!bookKey){ w.alert(`í•´ë‹¹ ì„±ê²½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: "${bookRaw}"`); return; }

    const ch=BOOKS[bookKey]?.[chap];
    if(!ch){ w.alert(`"${bookKey}" ${chap}ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; }

    const verses=(ch.paras||[]).flatMap(p=>p.verses||[]).filter(([v])=>v>=vFrom&&v<=vTo);
    if(!verses.length){ w.alert('í•´ë‹¹ êµ¬ì ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

    const header = `<div class="verse-header"><b>${bookKey} ${chap}:${vFrom}${vTo!==vFrom?'-'+vTo:''}</b></div>`;
    const html   = verses.map(([v,t])=>`<div class="verse-line"><sup>${v}</sup>${t}</div>`).join('');
    insertHTML(header+html); scheduleDraft();
  };

  // ğŸ”¹ ì´ë¯¸ì§€ ì—…ë¡œë“œ
  imgs.addEventListener('change', async ()=>{
    const P=w.opener||window.opener;
    const toDataURL=P&&P.fileToDataURL?P.fileToDataURL:null;
    const files=[...(imgs.files||[])];
    for(const f of files){
      try{
        const data=toDataURL?await toDataURL(f):await new Promise((res,rej)=>{
          const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);
        });
        const im=new w.Image(); im.src=data; th.appendChild(im);
      }catch(_){}
    }
    imgs.value=''; scheduleDraft();
  });

  // ğŸ”¹ ì¸ì‡„ / ì €ì¥ / ì‚­ì œ / ë‹«ê¸°
  $('print').onclick=()=>w.print();
  $('s').onclick=()=>{
    const images=[...th.querySelectorAll('img')].map(i=>i.src);
    window.postMessage({
      type:'sermon-save',
      title:(t.value||'').trim()||'(ì œëª© ì—†ìŒ)',
      body:b.innerHTML,
      images
    },'*');
    w.close();
  };
  $('d').onclick=()=>{ if(w.confirm('ì‚­ì œí• ê¹Œìš”?')){ window.postMessage({type:'sermon-delete'},'*'); w.close(); } };
  $('x').onclick=()=>w.close();

  // ğŸ”¹ ìë™ì €ì¥ (ìˆ˜ì •ë¨ â€” ì˜¤ë¥˜ ì—†ìŒ)
  const DRAFT_KEY=`wbps.sermon.draft.${meta.paraId}.${meta.idx}`;
  let draftTimer=null, dirty=false;
  function saveDraft(){
    try{
      const payload={
        title:(t.value||'').trim(),
        body:b.innerHTML,
        images:[...th.querySelectorAll('img')].map(i=>i.src),
        ts:Date.now()
      };
      localStorage.setItem(DRAFT_KEY,JSON.stringify(payload));
      draftState.textContent='ìë™ì €ì¥ ì™„ë£Œ'; dirty=false;
    }catch(e){ draftState.textContent='ìë™ì €ì¥ ì‹¤íŒ¨(ìš©ëŸ‰ ì´ˆê³¼?)'; }
  }
  function scheduleDraft(){
    draftState.textContent='ì…ë ¥ ì¤‘â€¦';
    dirty=true;
    if(draftTimer) w.clearTimeout(draftTimer);
    draftTimer=w.setTimeout(saveDraft,800);
  }
  function loadDraft(){
    try{
      const raw=localStorage.getItem(DRAFT_KEY);
      if(!raw) return;
      const d=JSON.parse(raw);
      if (typeof d?.title === 'string' && d.title.trim() !== '') t.value=d.title;
      if(d?.body)  b.innerHTML=d.body;
      if(Array.isArray(d?.images)){
        th.innerHTML='';
        d.images.forEach(src=>{
          const im=new w.Image(); im.src=src; th.appendChild(im);
        });
      }
      draftState.textContent='ì´ˆì•ˆ ë¶ˆëŸ¬ì˜´';
    }catch(_){}
  }
  t.addEventListener('input',scheduleDraft);
  b.addEventListener('input',scheduleDraft);
  w.addEventListener('beforeunload',()=>{ if(dirty) saveDraft(); });
  loadDraft();

  // ğŸ”¹ plain text ë³€í™˜ ìœ í‹¸
  function toPlainText(html){
    const tmp=w.document.createElement('div'); tmp.innerHTML=html||'';
    tmp.querySelectorAll('sup').forEach(s=> s.textContent='['+s.textContent+'] ');
    return (tmp.textContent||'').replace(/\s+\n/g,'\n').replace(/\n{2,}/g,'\n');
  }

    // ===== ì±… ì´ë¦„ í•´ì„ ìœ í‹¸ =====
    function resolveBookKey(input,BOOKS){
      const s=normalizeBookName(input); const keys=Object.keys(BOOKS);
      const byNorm=new Map(keys.map(k=>[normalizeBookName(k),k])); if(byNorm.has(s)) return byNorm.get(s);
      const alias=BOOK_ALIAS_MAP(); if(alias[s] && BOOKS[alias[s]]) return alias[s];
      const startHit=keys.find(k=>normalizeBookName(k).startsWith(s)); if(startHit) return startHit;
      const inclHit=keys.find(k=>normalizeBookName(k).includes(s)); if(inclHit) return inclHit;
      return null;
    }
    function normalizeBookName(x){
      return String(x||'').toLowerCase().replace(/\s+/g,'').replace(/[.\u00B7]/g,'').replace(/ì„œ$/,'').replace(/ë³µìŒì„œ?$/,'ë³µìŒ')
        .replace(/ì²«ì§¸|ë‘˜ì§¸|ì…‹ì§¸/g, m=>({'ì²«ì§¸':'1','ë‘˜ì§¸':'2','ì…‹ì§¸':'3'}[m])).replace(/[ì¼ì´ì‚¼]/g,m=>({'ì¼':'1','ì´':'2','ì‚¼':'3'}[m]))
        .replace(/ë¡¬ì„œ?$/,'ë¡¬').replace(/ê³ ë¦°ë„ì „ì„œ?$/,'ê³ ì „').replace(/ê³ ë¦°ë„í›„ì„œ?$/,'ê³ í›„').replace(/ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ?$/,'ì‚´ì „').replace(/ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ?$/,'ì‚´í›„')
        .replace(/ë””ëª¨ë°ì „ì„œ?$/,'ë”¤ì „').replace(/ë””ëª¨ë°í›„ì„œ?$/,'ë”¤í›„').replace(/ë² ë“œë¡œì „ì„œ?$/,'ë²§ì „').replace(/ë² ë“œë¡œí›„ì„œ?$/,'ë²§í›„')
        .replace(/ìš”í•œì¼ì„œ?$/,'ìš”1').replace(/ìš”í•œì´ì„œ?$/,'ìš”2').replace(/ìš”í•œì‚¼ì„œ?$/,'ìš”3');
    }
    function BOOK_ALIAS_MAP(){
      return {
        // êµ¬ì•½
        'ì°½':'ì°½ì„¸ê¸°','ì°½ì„¸ê¸°':'ì°½ì„¸ê¸°','ì°½ì„¸':'ì°½ì„¸ê¸°','ì¶œ':'ì¶œì• êµ½ê¸°','ì¶œì• êµ½ê¸°':'ì¶œì• êµ½ê¸°','ì¶œì• ':'ì¶œì• êµ½ê¸°','ë ˆ':'ë ˆìœ„ê¸°','ë ˆìœ„ê¸°':'ë ˆìœ„ê¸°','ë¯¼':'ë¯¼ìˆ˜ê¸°','ë¯¼ìˆ˜ê¸°':'ë¯¼ìˆ˜ê¸°','ì‹ ':'ì‹ ëª…ê¸°','ì‹ ëª…ê¸°':'ì‹ ëª…ê¸°',
        'ìˆ˜':'ì—¬í˜¸ìˆ˜ì•„','ì—¬í˜¸ìˆ˜ì•„':'ì—¬í˜¸ìˆ˜ì•„','ì‚¿':'ì‚¬ì‚¬ê¸°','ì‚¬ì‚¬ê¸°':'ì‚¬ì‚¬ê¸°','ë£»':'ë£»ê¸°','ë£»ê¸°':'ë£»ê¸°','ì‚¼ìƒ':'ì‚¬ë¬´ì—˜ìƒ','ì‚¬ë¬´ì—˜ìƒ':'ì‚¬ë¬´ì—˜ìƒ','ì‚¼í•˜':'ì‚¬ë¬´ì—˜í•˜','ì‚¬ë¬´ì—˜í•˜':'ì‚¬ë¬´ì—˜í•˜',
        'ì™•ìƒ':'ì—´ì™•ê¸°ìƒ','ì—´ì™•ê¸°ìƒ':'ì—´ì™•ê¸°ìƒ','ì™•í•˜':'ì—´ì™•ê¸°í•˜','ì—´ì™•ê¸°í•˜':'ì—´ì™•ê¸°í•˜','ëŒ€ìƒ':'ì—­ëŒ€ìƒ','ì—­ëŒ€ìƒ':'ì—­ëŒ€ìƒ','ëŒ€í•˜':'ì—­ëŒ€í•˜','ì—­ëŒ€í•˜':'ì—­ëŒ€í•˜',
        'ìŠ¤':'ì—ìŠ¤ë¼','ì—ìŠ¤ë¼':'ì—ìŠ¤ë¼','ëŠ':'ëŠí—¤ë¯¸ì•¼','ëŠí—¤ë¯¸ì•¼':'ëŠí—¤ë¯¸ì•¼','ì—':'ì—ìŠ¤ë”','ì—ìŠ¤ë”':'ì—ìŠ¤ë”','ìš¥':'ìš¥ê¸°','ìš¥ê¸°':'ìš¥ê¸°','ì‹œ':'ì‹œí¸','ì‹œí¸':'ì‹œí¸','ì ':'ì ì–¸','ì ì–¸':'ì ì–¸',
        'ì „':'ì „ë„ì„œ','ì „ë„ì„œ':'ì „ë„ì„œ','ì•„':'ì•„ê°€','ì•„ê°€':'ì•„ê°€','ì‚¬':'ì´ì‚¬ì•¼','ì´ì‚¬ì•¼':'ì´ì‚¬ì•¼','ë ˜':'ì˜ˆë ˆë¯¸ì•¼','ì˜ˆë ˆë¯¸ì•¼':'ì˜ˆë ˆë¯¸ì•¼','ì• ':'ì˜ˆë ˆë¯¸ì•¼ì• ê°€','ì˜ˆë ˆë¯¸ì•¼ì• ê°€':'ì˜ˆë ˆë¯¸ì•¼ì• ê°€',
        'ê²”':'ì—ìŠ¤ê²”','ì—ìŠ¤ê²”':'ì—ìŠ¤ê²”','ë‹¨':'ë‹¤ë‹ˆì—˜','ë‹¤ë‹ˆì—˜':'ë‹¤ë‹ˆì—˜','í˜¸':'í˜¸ì„¸ì•„','í˜¸ì„¸ì•„':'í˜¸ì„¸ì•„','ìšœ':'ìš”ì—˜','ìš”ì—˜':'ìš”ì—˜','ì•”':'ì•„ëª¨ìŠ¤','ì•„ëª¨ìŠ¤':'ì•„ëª¨ìŠ¤','ì˜µ':'ì˜¤ë°”ëŒœ','ì˜¤ë°”ëŒœ':'ì˜¤ë°”ëŒœ',
        'ìš˜':'ìš”ë‚˜','ìš”ë‚˜':'ìš”ë‚˜','ë¯¸':'ë¯¸ê°€','ë¯¸ê°€':'ë¯¸ê°€','ë‚˜':'ë‚˜í›”','ë‚˜í›”':'ë‚˜í›”','í•©':'í•˜ë°•êµ­','í•˜ë°•êµ­':'í•˜ë°•êµ­','ìŠµ':'ìŠ¤ë°”ëƒ','ìŠ¤ë°”ëƒ':'ìŠ¤ë°”ëƒ','í•™':'í•™ê°œ','í•™ê°œ':'í•™ê°œ','ìŠ¥':'ìŠ¤ê°€ë´','ìŠ¤ê°€ë´':'ìŠ¤ê°€ë´','ë§':'ë§ë¼ê¸°','ë§ë¼ê¸°':'ë§ë¼ê¸°',
        // ì‹ ì•½
        'ë§ˆ':'ë§ˆíƒœë³µìŒ','ë§ˆíƒœ':'ë§ˆíƒœë³µìŒ','ë§ˆíƒœë³µìŒ':'ë§ˆíƒœë³µìŒ','ë§‰':'ë§ˆê°€ë³µìŒ','ë§ˆê°€':'ë§ˆê°€ë³µìŒ','ë§ˆê°€ë³µìŒ':'ë§ˆê°€ë³µìŒ','ëˆ…':'ëˆ„ê°€ë³µìŒ','ëˆ„ê°€':'ëˆ„ê°€ë³µìŒ','ëˆ„ê°€ë³µìŒ':'ëˆ„ê°€ë³µìŒ',
        'ìš”':'ìš”í•œë³µìŒ','ìš”í•œë³µìŒ':'ìš”í•œë³µìŒ','í–‰':'ì‚¬ë„í–‰ì „','ì‚¬ë„í–‰ì „':'ì‚¬ë„í–‰ì „','ë¡¬':'ë¡œë§ˆì„œ','ë¡œë§ˆì„œ':'ë¡œë§ˆì„œ','ê³ ì „':'ê³ ë¦°ë„ì „ì„œ','ê³ ë¦°ë„ì „ì„œ':'ê³ ë¦°ë„ì „ì„œ','ê³ í›„':'ê³ ë¦°ë„í›„ì„œ','ê³ ë¦°ë„í›„ì„œ':'ê³ ë¦°ë„í›„ì„œ',
        'ê°ˆ':'ê°ˆë¼ë””ì•„ì„œ','ê°ˆë¼ë””ì•„ì„œ':'ê°ˆë¼ë””ì•„ì„œ','ì—¡':'ì—ë² ì†Œì„œ','ì—ë² ì†Œì„œ':'ì—ë² ì†Œì„œ','ë¹Œ':'ë¹Œë¦½ë³´ì„œ','ë¹Œë¦½ë³´ì„œ':'ë¹Œë¦½ë³´ì„œ','ê³¨':'ê³¨ë¡œìƒˆì„œ','ê³¨ë¡œìƒˆì„œ':'ê³¨ë¡œìƒˆì„œ',
        'ì‚´ì „':'ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ','ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ':'ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ','ì‚´í›„':'ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ','ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ':'ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ','ë”¤ì „':'ë””ëª¨ë°ì „ì„œ','ë””ëª¨ë°ì „ì„œ':'ë””ëª¨ë°ì „ì„œ','ë”¤í›„':'ë””ëª¨ë°í›„ì„œ','ë””ëª¨ë°í›„ì„œ':'ë””ëª¨ë°í›„ì„œ',
        'ë”›':'ë””ë„ì„œ','ë””ë„ì„œ':'ë””ë„ì„œ','ëª¬':'ë¹Œë ˆëª¬ì„œ','ë¹Œë ˆëª¬ì„œ':'ë¹Œë ˆëª¬ì„œ','íˆ':'íˆë¸Œë¦¬ì„œ','íˆë¸Œë¦¬ì„œ':'íˆë¸Œë¦¬ì„œ','ì•½':'ì•¼ê³ ë³´ì„œ','ì•¼ê³ ë³´ì„œ':'ì•¼ê³ ë³´ì„œ',
        'ë²§ì „':'ë² ë“œë¡œì „ì„œ','ë² ë“œë¡œì „ì„œ':'ë² ë“œë¡œì „ì„œ','ë²§í›„':'ë² ë“œë¡œí›„ì„œ','ë² ë“œë¡œí›„ì„œ':'ë² ë“œë¡œí›„ì„œ',
        'ìš”1':'ìš”í•œì¼ì„œ','ìš”ì¼1':'ìš”í•œì¼ì„œ','ìš”í•œì¼':'ìš”í•œì¼ì„œ','ìš”í•œì¼ì„œ':'ìš”í•œì¼ì„œ','ìš”2':'ìš”í•œì´ì„œ','ìš”ì¼2':'ìš”í•œì´ì„œ','ìš”í•œì´':'ìš”í•œì´ì„œ','ìš”í•œì´ì„œ':'ìš”í•œì´ì„œ',
        'ìš”3':'ìš”í•œì‚¼ì„œ','ìš”ì¼3':'ìš”í•œì‚¼ì„œ','ìš”í•œì‚¼':'ìš”í•œì‚¼ì„œ','ìš”í•œì‚¼ì„œ':'ìš”í•œì‚¼ì„œ','ìœ ':'ìœ ë‹¤ì„œ','ìœ ë‹¤ì„œ':'ìœ ë‹¤ì„œ','ê³„':'ìš”í•œê³„ì‹œë¡','ê³„ì‹œë¡':'ìš”í•œê³„ì‹œë¡','ìš”í•œê³„ì‹œë¡':'ìš”í•œê³„ì‹œë¡'
      };
    }
  });

  // ë¶€ëª¨ì°½ê³¼ í†µì‹  (ì €ì¥/ì‚­ì œ + ì´ˆì•ˆ ì‚­ì œ)
  const onMsg = (ev)=>{
    const data = ev?.data || {};
    if(!data.type) return;

    const map2 = getSermonMap();
    const arr2 = map2[CURRENT.paraId] || [];

    if(data.type === 'sermon-save'){
      const now=new Date();
      const date=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      if(arr2[idx]) arr2[idx] = { ...arr2[idx], title: data.title, body: data.body, images: data.images, date };
      map2[CURRENT.paraId]=arr2; setSermonMap(map2);
      try{ localStorage.removeItem(`wbps.sermon.draft.${CURRENT.paraId}.${idx}`); }catch(_){}
      status('ì„¤êµê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); renderSermonList(); window.removeEventListener('message', onMsg);
    }

    if(data.type === 'sermon-delete'){
      if(arr2[idx]) arr2.splice(idx,1);
      map2[CURRENT.paraId]=arr2; setSermonMap(map2);
      try{ localStorage.removeItem(`wbps.sermon.draft.${CURRENT.paraId}.${idx}`); }catch(_){}
      status('ì„¤êµê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); renderSermonList(); window.removeEventListener('message', onMsg);
    }
  };
  window.addEventListener('message', onMsg);
}

    // RTE íˆ´ë°” ë²„íŠ¼ (ëª¨ë‹¬ ì „ìš©)
    document.getElementById('rteBold')?.addEventListener('click', ()=> execFmt('bold'));
    document.getElementById('rteItalic')?.addEventListener('click', ()=> execFmt('italic'));
    document.getElementById('rteUnderline')?.addEventListener('click', ()=> execFmt('underline'));
    document.getElementById('rteApplyColor')?.addEventListener('click', ()=>{
      const hex = (document.getElementById('rteColor')?.value) || '#ffffff';
      applyColorImmediateToRTE(hex);
    });

    // Alt ë‹¨ì¶•í‚¤ (ë‚´ìš©ìš”ì•½/ë‹¨ìœ„/ì „ì²´/ì£¼ì„ ëª¨ë‹¬ì˜ RTE ì „ìš©)
    window.addEventListener('keydown', (e)=>{
      // ëª¨ë‹¬ì´ ë–  ìˆê³ , ëª¨ë‹¬ í¸ì§‘ê¸°ê°€ ë³´ì¼ ë•Œë§Œ
      if (modalWrap.getAttribute('aria-hidden') === 'true') return;
      if (sermonEditor.style.display === 'none') return;

      // Alt ì¡°í•©ë§Œ í—ˆìš©
      if (!e.altKey || e.ctrlKey || e.metaKey) return;

      // í¬ì»¤ìŠ¤ê°€ ë³¸ë¬¸ ë‚´ìš©(div#sermonBody) ë‚´ë¶€ì¼ ë•Œ
      const active = document.activeElement;
      const inEditor = active === sermonBody || sermonBody.contains(active);
      if (!inEditor) return;

      const k = (e.key||'').toLowerCase();
      if (!['b','i','u','c'].includes(k)) return;

      e.preventDefault(); e.stopPropagation();

      if (k === 'b') execFmt('bold');
      else if (k === 'i') execFmt('italic');
      else if (k === 'u') execFmt('underline');
      else if (k === 'c') {
        const hex = (document.getElementById('rteColor')?.value) || '#ffffff';
        applyColorImmediateToRTE(hex);
      }
    }, true);

/* ===== [ëª¨ë‹¬ í¸ì§‘ê¸° RTE ìŠ¤íƒ€ì¼Â·ë‹¨ì¶•í‚¤ ì§€ì› í™•ì¥] ===== */
(function enableModalRTEHotkeys(){
  const editor = document.getElementById('sermonEditor');
  const bodyEl = document.getElementById('sermonBody');
  if (!editor || !bodyEl) return;

  // execCommand ë˜í¼
  function execFmt(cmd, val=null){
    document.execCommand(cmd,false,val);
  }

  // ì„ íƒ ì˜ì—­ì— ìƒ‰ ì¦‰ì‹œ ì ìš©
  function applyColorImmediateToModal(hex){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0) return;
    const range = sel.getRangeAt(0);
    if(!bodyEl.contains(range.commonAncestorContainer)) return;
    document.execCommand('foreColor', false, hex);
  }

  // ===== Alt ë‹¨ì¶•í‚¤ (b,i,u,c,f) =====
  window.addEventListener('keydown', (e)=>{
    if (modalWrap.getAttribute('aria-hidden') === 'true') return;
    if (editor.style.display === 'none') return;
    if (!e.altKey || e.ctrlKey || e.metaKey) return;

    const active = document.activeElement;
    const inEditor = (active === bodyEl) || bodyEl.contains(active);
    if (!inEditor) return;

    const k = (e.key || '').toLowerCase();
    if (!['b','i','u','c','f'].includes(k)) return;
    e.preventDefault(); e.stopPropagation();

    switch(k){
      case 'b': execFmt('bold'); break;           // êµµê²Œ
      case 'i': execFmt('italic'); break;         // ê¸°ìš¸ì„
      case 'u': execFmt('underline'); break;      // ë°‘ì¤„
      case 'c': {                                 // ìƒ‰ ì¦‰ì‹œ ì ìš©
        const colorEl = document.getElementById('color');
        const hex = colorEl ? colorEl.value : '#ffffff';
        applyColorImmediateToModal(hex);
        break;
      }
      case 'f': {                                 // ê¸€ê¼´í¬ê¸°(px) ì ìš©
        const pxEl = document.getElementById('fontSizePx');
        const px = pxEl ? parseInt(pxEl.value,10) : 16;
        if(px && px>=10 && px<=64){
          document.execCommand('fontSize', false, 7);
          const fontTags = bodyEl.querySelectorAll('font[size="7"]');
          fontTags.forEach(ft=>{ ft.removeAttribute('size'); ft.style.fontSize = px+'px'; });
        }
        break;
      }
    }
  }, true);
})();

    // ë²„íŠ¼ í´ë¦­ ì§€ì› (ëª¨ë‹¬ í¸ì§‘ê¸°ìš©)
    document.getElementById('btnBold')?.addEventListener('click', ()=> document.execCommand('bold'));
    document.getElementById('btnItalic')?.addEventListener('click', ()=> document.execCommand('italic'));
    document.getElementById('btnUnderline')?.addEventListener('click', ()=> document.execCommand('underline'));
    document.getElementById('btnColor')?.addEventListener('click', ()=>{
      const c = document.getElementById('color')?.value || '#ffffff';
      document.execCommand('foreColor', false, c);
    });

// ---------- ë¶™ì—¬ë„£ì„ ë•Œ êµµì€ ê¸€ìì— ë…¸ë‘ìƒ‰ ìë™ ì ìš© ----------
document.addEventListener('paste', (e) => {
  // í˜„ì¬ ì»¤ì„œê°€ contenteditable í¸ì§‘ê¸° ì•ˆì´ ì•„ë‹ ê²½ìš° ë¬´ì‹œ
  const editor = document.activeElement;
  if (!editor || !editor.isContentEditable) return;

  e.preventDefault(); // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë§‰ê¸°

  // í´ë¦½ë³´ë“œì—ì„œ HTML ë˜ëŠ” í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
  const pasteHTML =
    (e.clipboardData || window.clipboardData).getData('text/html') ||
    (e.clipboardData || window.clipboardData).getData('text/plain');

  if (!pasteHTML) return;

  // <b>, <strong> íƒœê·¸ì— ìŠ¤íƒ€ì¼(color + font-weight) ì¶”ê°€
  const styledHTML = pasteHTML
    .replace(/<b(.*?)>/gi, `<b style="color:#ffd86b;font-weight:700;"$1>`)
    .replace(/<strong(.*?)>/gi, `<strong style="color:#ffd86b;font-weight:700;"$1>`);

  // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— HTML ì‚½ì…
  if (document.queryCommandSupported('insertHTML')) {
    document.execCommand('insertHTML', false, styledHTML);
  } else {
    editor.innerHTML += styledHTML;
  }
});

    // == ëª¨ë‹¬ í¸ì§‘ê¸° ë„êµ¬ ì ‘ê¸°/í¼ì¹˜ê¸° ==
(function(){
  const btn  = document.getElementById('modalToggleControlsBtn');
  const wrap = document.getElementById('modalControlsWrap');
  if(!btn || !wrap) return;

  const showBtnIfEditorVisible = ()=>{
    const editing = sermonEditor.style.display !== 'none';
    btn.style.display = editing ? '' : 'none';

    if(editing){
      const para = BIBLE?.books?.[CURRENT.book]?.[CURRENT.chap]?.paras?.[CURRENT.paraIdx];
      const pid  = para ? `${CURRENT.book}|${CURRENT.chap}|${para.ref}` : '';
      const KEY  = `wbps.modal.controls.collapsed:${pid}`;
      
      const raw = localStorage.getItem(KEY);
      // ì €ì¥ê°’ ì—†ìœ¼ë©´ ê¸°ë³¸=ì ‘í˜(true)
      const collapsed = (raw === null) ? true : (raw === '1');
      wrap.classList.toggle('collapsed', collapsed);
      btn.textContent = collapsed ? 'í¸ì§‘í•˜ê¸°' : 'ë„êµ¬ ë‹«ê¸°';
      
      btn.onclick = ()=>{
        const c = wrap.classList.toggle('collapsed');
        btn.textContent = c ? 'í¸ì§‘í•˜ê¸°' : 'ë„êµ¬ ë‹«ê¸°';
        localStorage.setItem(KEY, c ? '1' : '0');
      };
      
    }
  };

  // ì—ë””í„° ì§„ì… ì§€ì ì— í›„í‚¹
  const _openSingleDocEditor = openSingleDocEditor;
  openSingleDocEditor = function(kind){
    _openSingleDocEditor(kind);
    setTimeout(showBtnIfEditorVisible, 0);
  };
  const _startNewSermon = startNewSermon;
  startNewSermon = function(){
    _startNewSermon();
    setTimeout(showBtnIfEditorVisible, 0);
  };
  const _editSermon = editSermon;
  editSermon = function(idx){
    _editSermon(idx);
    setTimeout(showBtnIfEditorVisible, 0);
  };
})();

  // ===== ì„ íƒ ì‹œ ìë™ ë“±ì¥í•˜ëŠ” ì¸ë¼ì¸ íˆ´ë°” =====
(function(){
  const toolbar = document.getElementById('inlineToolbar');
  const colorInput = document.getElementById('textColor');
  if(!toolbar) return;

  // ë²„íŠ¼ ë™ì‘
  toolbar.addEventListener('click', (e) => {
    const cmd = e.target.dataset.cmd;
    if (!cmd) return;
    e.preventDefault();
    document.execCommand(cmd, false, null);
    hideToolbar();
  });

  // ìƒ‰ìƒ ì„ íƒ
  colorInput.addEventListener('input', () => {
    document.execCommand('foreColor', false, colorInput.value);
    hideToolbar();
  });

  // ë§ˆìš°ìŠ¤ë¡œ ê¸€ì ì„ íƒ ì‹œ íˆ´ë°” í‘œì‹œ
  document.addEventListener('mouseup', (e) => {
    const sel = window.getSelection();
    if (!sel.rangeCount || sel.isCollapsed) { hideToolbar(); return; }
    const range = sel.getRangeAt(0);
    const rect = range.getBoundingClientRect();
    showToolbar(rect.left + window.scrollX + rect.width / 2, rect.top + window.scrollY - 40);
  });

  document.addEventListener('scroll', hideToolbar);
  document.addEventListener('mousedown', (e)=>{
    if(!toolbar.contains(e.target)) hideToolbar();
  });

  function showToolbar(x, y) {
    toolbar.style.left = `${x - toolbar.offsetWidth / 2}px`;
    toolbar.style.top = `${y - 40}px`;
    toolbar.hidden = false;
    toolbar.style.opacity = '1';
  }

  function hideToolbar() {
    toolbar.hidden = true;
  }
})();

// ===== ë¶™ì—¬ë„£ê¸° ì‹œ êµµì€ ê¸€ìë§Œ ë…¸ë€ìƒ‰ =====
document.querySelectorAll('.rte, #sermonBody, #b').forEach(ed=>{
  ed.addEventListener('paste', (e)=>{
    e.preventDefault();
    const html = (e.clipboardData || window.clipboardData).getData('text/html') ||
                 (e.clipboardData || window.clipboardData).getData('text/plain');
    const temp = document.createElement('div');
    temp.innerHTML = html;

    // ê¸°ì¡´ <b>, <strong> ë§Œ ë…¸ë€ìƒ‰ ì²˜ë¦¬
    temp.querySelectorAll('b,strong').forEach(el=>{
      el.style.color = '#ffd86b';
    });

    document.execCommand('insertHTML', false, temp.innerHTML);
  });
});
    
  </script>

<!-- ===== ì„ íƒ ì‹œ ë‚˜íƒ€ë‚˜ëŠ” ì¸ë¼ì¸ íˆ´ë°” ===== -->
<div id="inlineToolbar" class="inline-toolbar" hidden>
  <button data-cmd="bold" title="êµµê²Œ(B)"><b>B</b></button>
  <button data-cmd="italic" title="ê¸°ìš¸ì„(I)"><i>I</i></button>
  <button data-cmd="underline" title="ë°‘ì¤„(U)"><u>U</u></button>
  <input type="color" id="textColor" title="ê¸€ììƒ‰" />
</div>
  
</body>
</html>
