<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Bible Paragraph Sermon</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#161922; --text:#e6e8ef; --muted:#9aa0ab;
      --accent:#6ea8fe; --border:#252a36; --danger:#ff6b6b; --titleBlue:#9fd0ff;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg); color:var(--text);
      display:grid; grid-template-rows:64px 1fr; gap:10px;
    }
    header{
      display:flex; align-items:center; gap:10px; padding:8px 10px;
      background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:5;
    }
    header h1{ font-size:16px; margin:0; font-weight:700 }
    .muted{ color:var(--muted) }
    .pill{
      display:flex; gap:8px; align-items:center; border:1px solid var(--border);
      background:color-mix(in hsl, var(--panel) 80%, black 8%); padding:6px 8px; border-radius:10px;
    }
    select, input[type="range"]{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:4px 6px }
    option{ color:#000 }
    button{
      background:color-mix(in hsl, var(--panel) 65%, black 10%); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:6px 10px; cursor:pointer;
      transition:border-color .15s, transform .04s;
    }
    button:hover{ border-color:color-mix(in hsl, var(--border) 80%, var(--accent) 20%) }
    button:active{ transform:translateY(1px) }
    .primary{
      background:linear-gradient(180deg,color-mix(in srgb, var(--accent) 75%, white 10%), color-mix(in srgb, var(--accent) 75%, black 20%));
      border-color:color-mix(in srgb, var(--accent) 70%, black 10%);
    }

    .layout{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 10px 12px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; min-width:0 }
    .scroller{ overflow:auto; padding:12px }
    .footer{ padding:8px 12px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap }

    #tree{ padding:8px }
    details{
      border:1px solid var(--border); border-radius:10px; padding:6px 8px; margin-bottom:8px;
      background:color-mix(in hsl, var(--panel) 80%, black 8%);
    }
    summary{ cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px }
    summary::-webkit-details-marker{ display:none }
    .tw{ font-weight:700 }
    .chapters{ display:grid; gap:6px; margin-top:6px }
    .paras{ display:grid; gap:6px; margin:8px 0 2px }
    .chip{
      font-size:.92em; padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      display:inline-flex; align-items:center; gap:6px; background:color-mix(in hsl, var(--panel) 88%, black 4%); white-space:nowrap;
    }
    .chip:hover{ border-color:var(--accent) }
    .ptitle{ font-weight:800; color:var(--titleBlue) }
    .vrange{ color:var(--muted); font-weight:700 }

    .pbody{ margin-top:8px; border-top:1px dashed var(--border); padding-top:8px }
    .ptoolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px }
    .ptoolbar .spacer { flex: 1 1 auto; }

    .pline{ padding:4px 6px; border-left:3px solid transparent; border-radius:8px; transition: background .15s, border-color .15s }
    .pline:hover{ background:color-mix(in hsl, var(--panel) 80%, black 12%) }
    .pline.reading{ background:color-mix(in hsl, var(--accent) 15%, black 0%); border-left-color:var(--accent) }
    .pv{ color:var(--muted); font-size:.88em; vertical-align:super; margin-right:4px }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal{ width:min(1200px, 96vw); max-height:94vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:14px }
    .modal .head{
      position:sticky; top:0; background:var(--panel); padding:12px 14px;
      display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--border)
    }
    .list{ padding:12px 14px; display:grid; gap:8px }
    .item{ border:1px solid var(--border); border-radius:10px; padding:6px 10px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
    .item-title{ font-weight:700; color:var(--titleBlue); line-height:1.15; display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .item-title .date{ margin-left:8px; color:var(--muted); font-weight:400; font-size:.92em }

    .editor{ padding:14px; display:grid; gap:12px; background:var(--panel) }
    .editor input[type="text"], .editor textarea{ width:100%; background:#161922; color:#e6e8ef; border:1px solid #2a3040; border-radius:8px; padding:10px 12px }
    .editor textarea{ min-height:360px; resize:vertical }
    .editor-bar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .editor-bar .grow{ flex:1 1 auto }

    .context-editor {
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      font-size: 1.05rem;
      line-height: 1.85;
      letter-spacing: 0.02em;
      word-break: keep-all;
      background: var(--panel);
      color: var(--text);
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }
    .context-editor input[type="text"]{
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      font-weight: 600;
      font-size: 1.12rem;
      letter-spacing: 0.01em;
    }
    .context-editor .rte{
      min-height:360px;resize:vertical;padding:14px;background:#161922;border:1px solid #2a3040;border-radius:10px;line-height:1.85;letter-spacing:.015em;caret-color:var(--accent);outline:none
    }
    .context-editor em,.context-editor strong,.context-editor b{
      color:#ffd66e;font-weight:600;font-style:normal
    }
    .context-editor blockquote{
      margin:12px 0;padding:10px 14px;border-left:3px solid var(--accent);
      color:#c0cad6;font-style:italic;background:rgba(255,255,255,.04);border-radius:8px
    }
    .context-editor ::selection{background:rgba(110,168,254,.25)}
    @media (max-width:640px){.context-editor{font-size:1rem}}
    @media (prefers-color-scheme:light){
      .context-editor{color:#1b2533;background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.08)}
      .context-editor blockquote{color:#445066;background:#f7f9fc}
    }

    #sermonEditor.context-editor .rte{
      line-height: 1.55 !important;
      letter-spacing: 0.01em !important;
    }
    #sermonEditor.context-editor .rte p{ margin: 6px 0; }
    #sermonEditor.context-editor .rte .verse-line{ line-height: 1.5; }
    #sermonEditor.context-editor .rte .verse-line sup{ margin-right:4px; }
    #sermonEditor.context-editor .rte br{ line-height: 1.0; }

    #sermonEditor{
      display:flex; flex-direction:column;
      height: calc(94vh - 56px); min-height: calc(94vh - 56px); max-height: calc(94vh - 56px);
      overflow: hidden;
    }
    #sermonEditor .rte {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding-top: var(--editor-pad-top, 0px);
      margin-top: 0 !important;
      scroll-padding-top: var(--editor-pad-top, 0px);
    }

    #rteToolbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }

    .inserted-verse { font-style: italic; color: #ff8080; }
    .verse-header { margin-bottom:2px; }
    .verse-line { font-style: italic; color:#ff8080; }

    .link-box{ display:flex; align-items:center; gap:6px; min-width:260px; flex:1 1 320px; }
    .link-box input{
      flex:1 1 auto; min-width:200px;
      background:#161922;color:#e6e8ef;border:1px solid #2a3040;border-radius:8px;padding:6px 8px
    }
    .link-box a{
      text-decoration:underline; color:#9fd0ff; word-break:break-all;
      max-width:280px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    /* 플로팅 서식툴바 */
    #wbp-plbar{
      position: fixed; left:0; top:0;
      transform: translate(-50%, calc(-100% - 10px));
      background:#0f1320; border:1px solid var(--border);
      border-radius:10px; padding:6px;
      display:flex; gap:6px; align-items:center;
      box-shadow:0 8px 20px rgba(0,0,0,.35); z-index:9999;
    }
    #wbp-plbar[hidden]{ display:none; }
    #wbp-plbar .divider{ width:1px; height:20px; background:var(--border); }
    #wbp-plbar button{
      border:1px solid var(--border); background:#1f2533; color:#e6e8ef;
      padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700;
    }
    #wbp-plbar button:hover{ background:#273046; }
    #wbp-plbar select{ background:#1f2533; color:#e6e8ef; border:1px solid var(--border); border-radius:6px; padding:4px 6px }

    /* 내용 채워진 버튼(filled) 시각 강조 + 항목별 색 */
    .ptoolbar button.filled { color:#fff; border-width:1px; box-shadow:0 0 6px rgba(0,0,0,0.25) }
    .ptoolbar .btnSummary.filled    { background:#6a5acd; border-color:#7b68ee; }
    .ptoolbar .btnUnitCtx.filled    { background:#9370db; border-color:#b48cf0; }
    .ptoolbar .btnWholeCtx.filled   { background:#4682b4; border-color:#5ca5e5; }
    .ptoolbar .btnCommentary.filled { background:#3cb371; border-color:#58d68d; }
    .ptoolbar .sermBtn.filled       { background:#ff8c00; border-color:#ffa94d; }
    .ptoolbar button.filled::after{
      content:"●"; font-size:10px; margin-left:6px; opacity:.85; color:rgba(255,255,255,.9);
    }

    /* 편집 모드 표시(선택) */
    details.para .pcontent[contenteditable="true"]{
      outline: 1px dashed #3b4b7a; outline-offset: 2px;
    }
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&family=Nanum+Myeongjo&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <h1>Web Bible Paragraph 3.0</h1>

    <div class="pill"><button id="btnSaveJSON">JSON 저장</button></div>

    <div class="pill">
      <button id="btnExportAll">내보내기</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="btnImportAll">가져오기</button>
    </div>

    <div class="pill">
      <span class="muted">음성</span>
      <select id="voiceSelect" title="한국어 보이스 선택">
        <option value="">브라우저 기본(ko-KR)</option>
      </select>
      <button id="testVoice">시험</button>
    </div>

    <div class="pill">
      <span class="muted">속도</span>
      <input id="rateCtl" type="range" min="0.6" max="1.4" step="0.02" value="0.95" />
      <span class="muted">톤</span>
      <input id="pitchCtl" type="range" min="0.6" max="1.4" step="0.02" value="1.00" />
    </div>

    <div class="pill" id="voiceHint" style="display:none">
      <span class="muted">한국어 보이스가 1개뿐이라 스타일 프리셋을 추가했습니다.</span>
    </div>

    <div style="flex:1"></div>
    <div class="pill"><span class="muted">단축키:</span> <span> S</span> 재생/중지 <span> · N</span> 다음 단락</div>
  </header>

  <div class="layout">
    <section class="card">
      <div class="scroller"><div id="tree"></div></div>
      <div class="footer"><div class="muted" id="status">bible-paragraph.json을 불러오는 중…</div></div>
    </section>
  </div>

  <div id="modalWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <strong id="modalTitle">단락 성경</strong>
        <span class="muted" id="modalRef">—</span>
        <div class="grow"></div>
        <button id="closeModal">닫기</button>
      </div>

      <div class="list" id="sermonList"></div>

      <!-- 단일 편집기 -->
      <div class="editor context-editor" id="sermonEditor" style="display:none">
        <div id="rteToolbar" class="editor-bar">
          <button type="button" onclick="document.execCommand('bold',false,null)"><b>B</b></button>
          <button type="button" onclick="document.execCommand('italic',false,null)"><i>I</i></button>
          <button type="button" onclick="document.execCommand('underline',false,null)"><u>U</u></button>
          <button type="button" onclick="document.execCommand('strikeThrough',false,null)"><s>S</s></button>
          <div class="grow"></div>
        </div>

        <input id="sermonTitle" type="text" placeholder="제목" style="display:none" />
        <div id="sermonBody" class="rte" contenteditable="true" spellcheck="false"></div>

        <div class="editor-bar">
          <div class="grow"></div>
          <button id="editorSpeak" class="primary">낭독</button>
          <button id="saveSermon" class="primary">저장</button>
        </div>
      </div>

      <div id="modalFooterNew" class="footer" style="padding:10px 14px; border-top:1px solid var(--border)">
        <button id="newSermonBtn" class="primary">새 설교</button>
      </div>
    </div>
  </div>

  <!-- 플로팅 서식툴바(절 선택 시 표시) -->
  <div id="wbp-plbar" hidden role="toolbar" aria-label="절 서식">
    <button type="button" data-cmd="bold" title="굵게 (Ctrl+B)"><b>B</b></button>
    <button type="button" data-cmd="italic" title="기울임 (Ctrl+I)"><i>I</i></button>
    <button type="button" data-cmd="underline" title="밑줄 (Ctrl+U)"><u>U</u></button>
    <div class="divider"></div>
    <!-- 여기 뒤에 6색 팔레트 + 기타 드롭다운이 JS로 주입됩니다 -->
  </div>

  <!-- 앱 본체 -->
  <script src="app.js" defer></script>

  <!-- v3.2 코어: 1) 저장소 -->
  <script>
  const WBP_FMT_KEY = 'wbps.versefmt.v2';
  const WBP_FMT = {
    map: {},
    load(){
      try { this.map = JSON.parse(localStorage.getItem(WBP_FMT_KEY) || '{}'); }
      catch { this.map = {}; }
    },
    save(){ localStorage.setItem(WBP_FMT_KEY, JSON.stringify(this.map)); },
    keyForLine(line){
      try{
        const para = line.closest('details.para'); if(!para) return null;
        const t = para.querySelector('summary .ptitle'); if(!t) return null;
        const book = t.dataset.book, ch = +t.dataset.ch, idx = +t.dataset.idx;
        const paraData = window.BIBLE?.books?.[book]?.[ch]?.paras?.[idx]; if(!paraData) return null;
        const v = line.dataset.verse || line.getAttribute('data-verse'); if(!v) return null;
        return `${book}|${ch}|${paraData.ref}|v${v}`;
      }catch{ return null; }
    },
    saveLine(line){
      const k = this.keyForLine(line); if(!k) return;
      this.map[k] = line.innerHTML;
      this.save();
    },
    restoreLine(line){
      const k = this.keyForLine(line); if(!k) return;
      const html = this.map[k];
      if (html) line.innerHTML = html;
    },
    restoreAll(root=document){
      root.querySelectorAll('.pline, .verse-line, p.verse').forEach(el=>this.restoreLine(el));
    }
  };
  WBP_FMT.load();
  </script>

  <!-- v3.2 코어: 2) 렌더 완료 복원 + 백업 옵저버 -->
  <script>
  // buildTree() 끝에서 app.js가 dispatch 해야 함:
  // document.dispatchEvent(new CustomEvent('wbp:treeBuilt'));
  document.addEventListener('wbp:treeBuilt', ()=>{
    const root = document.getElementById('tree') || document;
    WBP_FMT.restoreAll(root);
  });

  // 구형/백업: 트리 내부 DOM 추가 시 새 절 자동 복원
  (function(){
    const root = document.getElementById('tree');
    if(!root) return;
    // 초기 1회 스윕
    WBP_FMT.restoreAll(root);
    const mo = new MutationObserver((muts)=>{
      for(const m of muts){
        m.addedNodes?.forEach?.(n=>{
          if(!(n instanceof HTMLElement)) return;
          if(n.matches?.('.pline, .verse-line, p.verse')) WBP_FMT.restoreLine(n);
          n.querySelectorAll?.('.pline, .verse-line, p.verse')?.forEach?.(x=>WBP_FMT.restoreLine(x));
        });
      }
    });
    mo.observe(root, {subtree:true, childList:true});
  })();
  </script>

  <!-- v3.2 코어: 3) 플로팅툴바 표시/적용 즉시 저장 + 6색 팔레트 -->
  <script>
  (function enableFloatingToolbar(){
    const bar = document.getElementById('wbp-plbar');
    if(!bar) return;

    // 6색 팔레트 + 기타 드롭다운 주입
    (function injectPalette(){
      if(bar.querySelector('.wbp-colors')) return;
      const PALETTE = ['#ff4d4f','#faad14','#fadb14','#52c41a','#1677ff','#722ed1'];
      const wrap = document.createElement('div');
      wrap.className = 'wbp-colors';
      PALETTE.forEach(hex=>{
        const b = document.createElement('button');
        b.type='button'; b.title=hex; b.style.cssText=`width:22px;height:22px;border-radius:5px;border:1px solid #2a3040;background:${hex};`;
        b.addEventListener('click', ()=>{
          document.execCommand?.('foreColor', false, hex);
          saveCurrentLine();
        });
        wrap.appendChild(b);
      });
      const more = document.createElement('select');
      more.innerHTML = `
        <option value="">기타 색</option>
        <option value="#000000">검정</option>
        <option value="#666666">회색</option>
        <option value="#ffffff">흰색</option>
        <option value="#ff69b4">핑크</option>
        <option value="#00ced1">청록</option>
      `;
      more.addEventListener('change', ()=>{
        if (!more.value) return;
        document.execCommand?.('foreColor', false, more.value);
        saveCurrentLine();
        more.value='';
      });
      bar.appendChild(wrap);
      bar.appendChild(more);
    })();

    // 선택 라인 탐색
    function currentLineFromSelection(){
      const sel = window.getSelection?.();
      if(!sel || !sel.rangeCount) return null;
      const n = sel.getRangeAt(0).commonAncestorContainer;
      const el = (n.nodeType===1 ? n : n.parentElement);
      return el?.closest?.('.pline, .verse-line, p.verse') || null;
    }
    function hasRealSelection(){
      const sel = window.getSelection?.();
      return !!(sel && sel.rangeCount && !sel.getRangeAt(0).collapsed);
    }
    function selRect(){
      const sel = window.getSelection();
      if(!sel || sel.rangeCount===0) return null;
      const r = sel.getRangeAt(0).cloneRange();
      let rect = r.getBoundingClientRect();
      if(!rect || (rect.width===0 && rect.height===0)){
        const span = document.createElement('span');
        span.appendChild(document.createTextNode('\u200b'));
        r.insertNode(span);
        rect = span.getBoundingClientRect();
        span.remove();
      }
      return rect;
    }
    let savedRange=null;
    function saveSel(){ const s=window.getSelection(); if(s&&s.rangeCount>0) savedRange=s.getRangeAt(0).cloneRange(); }
    function restoreSel(){ if(!savedRange) return false; const s=window.getSelection(); s.removeAllRanges(); s.addRange(savedRange); return true; }

    function showBarMaybe(){
      if(!hasRealSelection()){ hide(); return; }
      const line = currentLineFromSelection();
      if(!line){ hide(); return; }
      // contenteditable 보장(필요 시)
      (line.closest('.pcontent, .editor, main, body')||line).setAttribute('contenteditable','true');
      const rect = selRect(); if(!rect){ hide(); return; }
      bar.style.left = (rect.left + rect.width/2) + 'px';
      bar.style.top  = rect.top + 'px';
      bar.hidden = false;
      saveSel();
    }
    function hide(){ bar.hidden = true; }

    // 툴바 기본 버튼(B/I/U) → 적용 후 저장
    bar.addEventListener('mousedown', e=> e.preventDefault());
    bar.addEventListener('click', e=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const cmd = btn.dataset.cmd;
      if(cmd){
        if(!restoreSel()) return;
        document.execCommand(cmd,false,null);
        setTimeout(saveCurrentLine, 0);
        setTimeout(showBarMaybe, 0);
      }
    });

    // 단축키(B/I/U) 후 저장
    document.addEventListener('keydown', (e)=>{
      if(!(e.ctrlKey||e.metaKey)) return;
      const k = e.key?.toLowerCase();
      if(!['b','i','u'].includes(k)) return;
      setTimeout(saveCurrentLine, 0);
    });
    // 입력/마우스업에도 저장
    document.addEventListener('input', ()=> setTimeout(saveCurrentLine, 120));
    document.addEventListener('mouseup', ()=> setTimeout(showBarMaybe, 0));
    document.addEventListener('selectionchange', ()=> setTimeout(showBarMaybe, 0));
    window.addEventListener('scroll', hide, {passive:true});
    window.addEventListener('resize', hide);

    function saveCurrentLine(){
      const line = currentLineFromSelection(); if(!line) return;
      WBP_FMT.saveLine(line);
    }
  })();
  </script>

  <!-- v3.2 코어: 4) 단락 서식 초기화 버튼 + filled 상태 토글 -->
  <script>
  // 버튼 filled 상태 갱신(내용흐름/단위/전체/주석/설교)
  (function filledStatePatch(){
    function safe(fn, fb){ try{ return fn(); }catch{ return fb; } }
    function paraId(book, chap, idx){
      const para = safe(()=>BIBLE.books[book][chap].paras[idx], null);
      return para ? `${book}|${chap}|${para.ref}` : null;
    }
    function pickMeta(paraEl){
      const t = paraEl.querySelector('summary .ptitle'); if(!t) return null;
      return { book:t.dataset.book, chap:+t.dataset.ch, idx:+t.dataset.idx };
    }
    function hasDoc(map, pid){
      const d=(map||{})[pid]; if(!d) return false;
      const b=(d.body||'').replace(/\s+/g,''); const ti=(d.title||'').replace(/\s+/g,'');
      return !!(b||ti);
    }
    function hasSermon(sermonMap, pid){
      const arr=(sermonMap||{})[pid]||[]; if(!Array.isArray(arr)||arr.length===0) return false;
      return arr.some(it=> (it.body||'').replace(/\s+/g,'') || (it.title||'').replace(/\s+/g,''));
    }
    function applyFilled(paraEl){
      const m = pickMeta(paraEl); if(!m) return;
      const pid = paraId(m.book, m.chap, m.idx); if(!pid) return;

      const sermonMap = safe(()=>JSON.parse(localStorage.getItem(STORAGE_SERMON)||'{}'),{});
      const unitMap   = safe(()=>JSON.parse(localStorage.getItem(STORAGE_UNIT_CTX)||'{}'),{});
      const wholeMap  = safe(()=>JSON.parse(localStorage.getItem(STORAGE_WHOLE_CTX)||'{}'),{});
      const commMap   = safe(()=>JSON.parse(localStorage.getItem(STORAGE_COMMENTARY)||'{}'),{});
      const sumMap    = safe(()=>JSON.parse(localStorage.getItem(STORAGE_SUMMARY)||'{}'),{});

      const tb = paraEl.querySelector('.ptoolbar'); if(!tb) return;
      const q = s=>tb.querySelector(s);

      q('.btnSummary')   ?.classList.toggle('filled', hasDoc(sumMap,  pid));
      q('.btnUnitCtx')   ?.classList.toggle('filled', hasDoc(unitMap, pid));
      q('.btnWholeCtx')  ?.classList.toggle('filled', hasDoc(wholeMap,pid));
      q('.btnCommentary')?.classList.toggle('filled', hasDoc(commMap, pid));
      q('.sermBtn')      ?.classList.toggle('filled', hasSermon(sermonMap, pid));
    }
    function sweep(){ document.querySelectorAll('#tree details.para').forEach(applyFilled); }

    // buildTree 이후 갱신
    document.addEventListener('wbp:treeBuilt', sweep);
    // 구조 변동 시 갱신
    (function(){
      const root=document.getElementById('tree'); if(!root) return;
      setTimeout(sweep, 200);
      new MutationObserver(()=>sweep()).observe(root, {subtree:true, childList:true});
    })();
  })();

  // 단락 서식초기화 버튼 자동 삽입
  (function injectParaClearButton(){
    function metaFromParaEl(paraEl){
      const t = paraEl.querySelector('summary .ptitle'); if(!t) return null;
      const book=t.dataset.book, chap=+t.dataset.ch, idx=+t.dataset.idx;
      if(!book||!Number.isFinite(chap)||!Number.isFinite(idx)) return null;
      return {book,chap,idx};
    }
    function clearFormattingForPara(paraEl){
      const m = metaFromParaEl(paraEl); if(!m) return alert('단락 정보를 찾을 수 없습니다.');
      const para = window.BIBLE?.books?.[m.book]?.[m.chap]?.paras?.[m.idx]; if(!para) return alert('성경 본문 데이터가 없습니다.');

      const prefix = `${m.book}|${m.chap}|${para.ref}|`;
      const map = {...WBP_FMT.map};
      let count = 0;
      for(const k of Object.keys(map)){
        if(k.startsWith(prefix)){ delete map[k]; count++; }
      }
      WBP_FMT.map = map; WBP_FMT.save();

      // DOM 복원(원문으로)
      paraEl.querySelectorAll('.pline, .verse-line, p.verse').forEach(line=>{
        const sup = line.querySelector('sup')?.outerHTML || '';
        const text = line.textContent.replace(/^\s*\d+\s*/, '').trim();
        line.innerHTML = sup + (text || '');
      });

      alert(`이 단락의 절 서식 ${count}개를 초기화했습니다.`);
    }

    function addBtn(tb, paraEl){
      if(tb.querySelector('.btnClearFmt')) return;
      const btn = document.createElement('button');
      btn.className = 'btnClearFmt';
      btn.textContent = '서식초기화';
      btn.title = '이 단락 안의 굵게/기울임/밑줄/색상 서식을 초기화합니다.';
      btn.style.background = '#552222';
      btn.style.color = '#fff';
      btn.style.border = '1px solid #aa4444';
      btn.style.borderRadius = '8px';
      btn.addEventListener('click', ()=> clearFormattingForPara(paraEl));
      tb.appendChild(btn);
    }

    const root = document.getElementById('tree'); if(!root) return;
    // 초기
    root.querySelectorAll('details.para').forEach(paraEl=>{
      const tb=paraEl.querySelector('.ptoolbar'); if(tb) addBtn(tb, paraEl);
    });
    // 이후 추가되는 단락도 주입
    new MutationObserver((muts)=>{
      for(const m of muts){
        m.addedNodes?.forEach?.(n=>{
          if(!(n instanceof HTMLElement)) return;
          const paraEl = n.matches?.('details.para') ? n : n.closest?.('details.para');
          const tb = paraEl?.querySelector?.('.ptoolbar');
          if(paraEl && tb) addBtn(tb, paraEl);
        });
      }
    }).observe(root, {subtree:true, childList:true});
  })();
  </script>

    <script>
    // === Export handler dedupe guard ===
    (function ensureSingleExportHandler(){
      const btn = document.getElementById('btnExportAll');
      if(!btn) return;
    
      // 이미 바인딩 했다면 재바인딩 금지
      if (btn.dataset.boundExport === '1') return;
    
      // 혹시 인라인 onclick이 있다면 제거(한 번에 끝)
      if (typeof btn.onclick === 'function') btn.onclick = null;
    
      // 기존에 addEventListener로 묶인 게 있을 수 있으니,
      // 버튼을 클론→교체하여 모든 이전 리스너를 '초기화'
      const clone = btn.cloneNode(true);
      clone.id = 'btnExportAll';              // id 유지
      clone.dataset.boundExport = '1';        // 바인딩 완료 마크
      btn.replaceWith(clone);
    
      // 이제부터는 우리 쪽 핸들러만 연결하면 두 번 실행 안 됨
      window.__WBP_GET_EXPORT_BUTTON__ = () => document.getElementById('btnExportAll');
    })();
    </script>
  
    <!-- === WBP Export/Import (절문장 서식 포함) === -->
    <script>
    window.addEventListener('DOMContentLoaded', function(){
      // 내보낼 로컬스토리지 키 필터: 우리 앱 네임스페이스 + 반드시 포함해야 하는 키
      const EXPORT_PREFIXES = ['wbps.', 'WBP.', 'wbp.'];   // 네임스페이스 프리픽스
      const MUST_KEYS = [
        'wbps.versefmt.v1',            // ✅ 절문장 서식맵
        'STORAGE_SERMON',              // 설교 목록(프로젝트별 상이할 수 있음)
        'STORAGE_UNIT_CTX',            // 단위성경속 맥락
        'STORAGE_WHOLE_CTX',           // 전체성경속 맥락
        'STORAGE_COMMENTARY',          // 주석
        'STORAGE_SUMMARY'              // 내용흐름 요약
      ];
    
      function isOurKey(k){
        return EXPORT_PREFIXES.some(p=> k.startsWith(p)) || MUST_KEYS.includes(k);
      }
    
      function collectAll(){
        const out = {};
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(!isOurKey(k)) continue;
          const raw = localStorage.getItem(k);
          try{ out[k] = JSON.parse(raw); } catch{ out[k] = raw; }
        }
        return out;
      }
    
      function downloadJSON(obj, name){
        const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
        const a = document.createElement('a');
        const t = new Date();
        const fname = name || `wbp-export-${t.getFullYear()}${String(t.getMonth()+1).padStart(2,'0')}${String(t.getDate()).padStart(2,'0')}-${String(t.getHours()).padStart(2,'0')}${String(t.getMinutes()).padStart(2,'0')}${String(t.getSeconds()).padStart(2,'0')}.json`;
        a.href = URL.createObjectURL(blob);
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      }
    
      // === 내보내기 버튼 ===
  const btnExport = (window.__WBP_GET_EXPORT_BUTTON__?.() || document.getElementById('btnExportAll'));
  function handleExportClick(e){
    e.preventDefault();
    e.stopImmediatePropagation();  // 혹시 남아있는 다른 리스너가 또 받지 못하게
    const payload = {
      __type: 'WBP_EXPORT',
      __version: '3.2',
      __createdAt: new Date().toISOString(),
      data: collectAll()
    };
    downloadJSON(payload);
  }
  // 중복 방지: data-boundExport 체크
  if (btnExport && btnExport.dataset.boundExport !== '2') {
    btnExport.addEventListener('click', handleExportClick, {capture:true});
    btnExport.dataset.boundExport = '2';
  }

  // === 가져오기 버튼/파일 ===
  const btnImport = document.getElementById('btnImportAll');
  const fileInp   = document.getElementById('importFile');
  btnImport?.addEventListener('click', ()=> fileInp?.click());
  fileInp?.addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () =>{
      try{
        const json = JSON.parse(String(reader.result||'{}'));
        const bag = json.data || json;
        let count = 0;
        for(const [k,v] of Object.entries(bag)){
          if(!k) continue;
          localStorage.setItem(k, typeof v==='string' ? v : JSON.stringify(v));
          count++;
        }
        alert(`가져오기 완료: ${count}개 항목을 복원했습니다.`);
        document.dispatchEvent(new CustomEvent('wbp:importApplied'));
        document.dispatchEvent(new CustomEvent('wbp:treeBuilt'));
      }catch(err){
        console.error(err);
        alert('가져오기 실패: JSON 파싱 오류');
      }finally{
        e.target.value = '';
      }
    };
    reader.readAsText(f, 'utf-8');
  });
});
</script>


</body>
</html>
